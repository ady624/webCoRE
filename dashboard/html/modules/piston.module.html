<status ng-if="status" ng-animate ng-bind-html="status" ng-click="setStatus()"></status>
<logo ng-if="view != 'dashboard'"><img src="https://community.webcore.co/uploads/default/original/2X/d/d82aa5d0f719318d1f35bafdec06e2c8cf3c54be.svg"></logo>
	<div id="preloader">
  		<div id="loader"></div>
	</div>
<error ng-if="error" ng-animate><p ng-bind-html="error"></p><button class="btn btn-default" ng-click="home()">Go home</button></error>

<!-- Start nav -->
<nav ng-if="initialized" ng-animate class="navbar navbar-inverse navbar-fixed-top">
	<div class="container-fluid">

<!-- Brand section -->

		<div class="navbar-header">
			<button ng-if="mode=='edit'" id="navbar-btn" type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<button ng-if="mode=='view'" id="navbar-btn" type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar-view-collapse" aria-expanded="false">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>

<!-- View mode -->

			<div ng-if="mode=='view'" class="nav navbar-nav btn-group hidden-xs hidden-sm">
				<span class="title btn" title="Back to piston list" ng-click="home()"><i class="fa fa-chevron-left"></i>&nbsp;{{location.name}} \ {{instance.name}} ({{instance.coreVersion.split('.').splice(0,3).join('.')}})</span>
			</div>
			<div ng-if="mode=='view'" class="nav navbar-nav btn-group hidden-md hidden-lg">
					<span class="title btn" title="Back to piston list" ng-click="home()"><i class="fa fa-chevron-left"></i>&nbsp;Back</span>
			</div>
			<div ng-if="mode=='view'" class="collapse navbar-collapse" id="navbar-view-collapse">
       	<ul class="nav navbar-nav">
        	<li class="dropdown">
						<ul class="dropdown-menu">
							<li class="dropdown"><a href="" ng-click="edit();" title="Edit the piston"><i class="fas fa-pencil fa-lg fa-fw"></i> Edit</a></li>
							<li class="dropdown"><a href="" ng-click="test();" title="Test the piston"><i class="fas fa-play-circle fa-lg fa-fw"></i> Test</a></li>
							<li class="dropdown"><a href="" ng-click="snapshot(true);" title="Take an anonymized snapshot of the piston"><i class="fas fa-camera fa-lg fa-fw"></i> Anonymized Snapshot</a></li>
							<li class="dropdown"><a href="" ng-click="snapshot();" title="Take a snapshot of the piston"><i class="fas fa-camera fa-lg fa-fw"></i> Snapshot</a></li>
							<li class="dropdown"><a href="" ng-click="textSnapshot();" title="Copy piston to clipboard"><i class="fal fa-copy fa-lg fa-fw"></i> Copy Piston</a></li>
							<li ng-if="trace && trace.points"><a href="" ng-click="view.trace = !view.trace; toggleView(null);"><checkbox checked="view.trace" icon-class="fa-lg fa-fw"></checkbox> Trace</a></li>
							<li class="dropdown"><a href="" ng-click="deleteDialog();" title="Delete piston"><i class="fal fa-times fa-lg fa-fw"></i> Delete</a></li>
						</ul>
					</li>
        </ul>
			</div>

<!-- End view mode -->

<!-- Edit mode -->

			<div ng-if="mode=='edit'" class="nav navbar-nav btn-group hidden-xxs">
				<button class="btn btn-default {{view.variables ? 'active' : ''}}" ng-click="toggleView('variables');" title="Show variables"><i class="far fa-superscript"></i></button>
				<button class="btn btn-default {{view.elseIfs ? 'active' : ''}}" ng-click="toggleView('elseIfs');" title="Show complex IFs"><i class="far fa-code-branch"></i></button>
				<button class="btn btn-default {{view.restrictions ? 'active' : ''}}" ng-click="toggleView('restrictions');" title="Show restrictions"><i class="fas fa-filter"></i></button>
				<button class="btn btn-default {{view.movable ? 'active' : ''}}" ng-click="toggleView('movable');" title="Allow moving of items by drag & drop"><i class="fas fa-sort"></i></button>
				<button class="btn btn-default {{view.console ? 'active' : ''}}" ng-click="toggleView('console');" title="Show evaluation console"><i class="fal fa-terminal"></i></button>
			</div>
			<div ng-if="mode=='edit'" class="nav navbar-nav btn-group">
				<button class="btn btn-default" title="Undo" ng-click="undo();" ng-disabled="!stack || !stack.undo || !stack.undo.length"><i class="fa fa-undo"></i>
				</button>
				<button class="btn btn-default" title="Redo" ng-click="redo();" ng-disabled="!stack || !stack.redo || !stack.redo.length"><i class="fas fa-redo"></i>
				</button>
			</div>
		</div>

<!-- Collect the nav links, forms, and other content for toggling -->

		<div ng-if="mode=='edit'" class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">

			<ul class="nav navbar-nav navbar-right">
			<li class="dropdown">
				<a ng-if="(mode=='edit') && !!meta.build" ng-click="cancel();" role="button">Cancel</a>
			</li>
			<li class="dropdown">
				<a ng-if="(mode=='edit')" ng-click="deleteDialog();" role="button">Delete</a>
			</li>
			<li class="dropdown">
				<a ng-if="mode=='edit'" ng-click="save();" role="button">Save</a>


			<li ng-if="mode=='edit'" class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-haspopup="true" aria-expanded="false">Options <span class="caret"></span></a>
					<ul class="dropdown-menu">
						<li ng-click="toggleView('variables');"><a><checkbox checked="view.variables" icon-class="fa-lg fa-fw"></checkbox> Show variables</a>
						</li>
						<li ng-click="toggleView('elseIfs');"><a><checkbox checked="view.elseIfs" icon-class="fa-lg fa-fw"></checkbox> Show complex IFs</a>
						</li>
						<li ng-click="toggleView('restrictions');"><a><checkbox checked="view.restrictions" icon-class="fa-lg fa-fw"></checkbox> Show restrictions</a>
						</li>
						<li role="separator" class="divider"></li>
						<li ng-click="toggleView('advancedStatements');"><a><checkbox checked="view.advancedStatements" icon-class="fa-lg fa-fw"></checkbox> Show advanced statements</a>
						</li>
						<li ng-click="toggleView('settings');"><a><checkbox checked="view.settings" icon-class="fa-lg fa-fw"></checkbox> Show piston settings</a>
						</li>
						<li ng-click="toggleView('whens');"><a><checkbox checked="view.whens" icon-class="fa-lg fa-fw"></checkbox> Show when true/false actions</a>
						</li>
						<li role="separator" class="divider"></li>
						<li ng-click="toggleView('console');"><a><checkbox checked="view.console" icon-class="fa-lg fa-fw"></checkbox> Show evaluation console</a>
						</li>
					</ul>

			</ul>
		</div>
	</div>
</nav>

<!-- End nav -->


<viewer ng-if="initialized" ng-animate options="{{viewerPiston.showOptions}}" mode="{{mode}}">
	<div header ng-if="mode=='view'">
		<div class="container">
			<div class="row">
				<h2 class="title">{{meta.name}}</h2>
			</div>
		</div>
	</div>

	<div class="container" ng-if="mode=='view'">
		
		<div warning ng-if="meta.active && !subscriptions.events && !schedules.length && !piston.o.des" class="alert alert-warning">This piston does not subscribe to any events. Unless executed by other means, it will never run on its own.</div>

		<div class="text-right">
			<span class="fas fa-caret-down collapse-control rotate-on-collapse" data-toggle="collapse" collapse-control data-target="#collapseCards" aria-expanded="true" small title="Hide/Show"></span>
		</div>
		
		<div class="row">
			
			<div class="collapse in" collapse-target id="collapseCards">
				<div class="col-md-4">
					<div class="columnCards">
						<h2>Status</h2>
						<div ng-if="meta.active">
							<p>This piston is currently active and humming happily.</p>
							<button class="btn btn-default" ng-click="pause();">Pause »</button>
						</div>
						<div ng-if="!meta.active">
							<p>This piston is currently <span class="danger">PAUSED</span>. No actions will be performed by this piston until you resume it.</p>
							<button class="btn btn-default" ng-click="resume();">Resume »</button>
						</div>
						<hr/>
						<p>Piston Category</p>
						<div>
							<select selectpicker ng-model="$parent.$parent.category" class="form-control" ng-change="setCategory()"><option ng-repeat="category in categories" value="{{category.i}}">{{category.n ? category.n : '(no name)'}}</option></select>
						</div>
					</div>
				</div>

				<div class="col-md-4">
					<div class="columnCards">
					<h2>Quick Facts</h2>
					<p>Piston state: <span ng-bind-html="renderString(state.new)"></span></p>
					<p>Last executed: {{lastExecuted ? utcToString(lastExecuted) : 'never'}}</p>
					<p>Next scheduled: {{nextSchedule ? utcToString(nextSchedule) : 'never'}}</p>
					<p>Subscriptions: {{subscriptions.events ? subscriptions.events : 'no'}} event{{subscriptions.events != 1 ? 's' : ''}}, {{subscriptions.controls ? subscriptions.controls : 'no'}} control{{subscriptions.controls != 1 ? 's' : ''}}</p>
					<p>Devices used: {{subscriptions.devices ? subscriptions.devices : 'none'}}</p>
					<p>Memory used: {{memory ? memory : 'unknown'}}</p>
					<p>External URL: <a href="{{endpoint}}" target="_blank">(click to open/execute)</a></p>
				</div>
				</div>


				<div class="col-md-4">
					<div class="columnCards">

					<h2>Automatic Backup</h2>
					<div ng-if="meta.bin">
						<p> Automatic backup enabled. </p>
						<p>{{mobile ? 'Touch' : 'Click'}} the box to reveal your backup bin code. Make a note of this code as you may use it later to restore a deleted piston.</p>
						<p class="well bin animated" reveal="{{revealing}}" ng-click="revealBin();">{{meta.bin}}</p>
						<p class="text-center"><b>Do NOT share this code with anyone.</b></p>
					</div>
					<div ng-if="!meta.bin">
						<p>You do not have automatic backup enabled for this piston.</p>
						<button class="btn btn-default" ng-click="enableAutomaticBackup()">Enable automatic backup »</button>

					</div>
				</div>
			</div>
				</div>
			</div>



			<div class="row">
				<div class="col-md-12">
					<span class="fas fa-caret-down pull-right collapse-control rotate-on-collapse" data-toggle="collapse" collapse-control data-target="#collapseScript" aria-expanded="true" small title="Hide/Show"></span>
					<h3 class="pull-left">
						Script 
					</h3>
						<div class="collapse navbar-collapse script" id="navbar-view-collapse">
							<div ng-include="'piston-editor-buttons'"></div>
						</div>

						<div class="clearfix"></div>
						<div class="collapse in" collapse-target id="collapseScript">
							<piston id="piston" ng-if="initialized" mode="{{mode}}" ng-repeat="piston in [piston]" data-nag-model="piston" ng-include="'piston'" trace="{{view.trace && (mode=='view') && !!trace && !!trace.points}}" no-animation context-menu="contextMenu()" context-menu-class="contextmenu"></piston>
							<div ng-include="'piston-editor-buttons'" class="hidden-xs"></div>
						</div>
				</div>
			</div>

			<div class="row">

				<div class="col-md-12 col-lg-6">
					<h3>
						<span class="fas fa-caret-down pull-right collapse-control rotate-on-collapse" data-toggle="collapse" collapse-control data-target="#collapseLogs" aria-expanded="true" small title="Hide/Show"></span>
						Logs
					</h3>
					<div class="collapse in" collapse-target id="collapseLogs">

					<div class="logs">
						<table class="table logs table-striped">
							<thead>
								<tr ng-if="logs.length == 0">
									<th>The log is empty</th>
								</tr>
							</thead>
							<tbody>
								<tr ng-repeat="log in logs" log="{{log.c}}">
									<td ng-if="log.t" colspan="2" class="hdr">{{utcToString(log.t) + ' +' + (log.t % 1000) + 'ms'}}</td>
									<td ng-if-start="log.o != null">+{{log.o}}ms</td>
									<td ng-if-end>{{log.p}}<span ng-bind-html="renderString(log.m)"></span></td>
								</tr>
							</tbody>
						</table>
					</div>
					<div class="form-group clearfix">
						<button ng-if="logs && logs.length" class="btn btn-default" ng-click="clearLogs();" title="Clear the logs">Clear</button>
						<select selectpicker class="selectpicker show-tick pull-right" data-style="btn-default" data-mobile="{{mobile}}" ng-change="setLoggingLevel($parent);" ng-model="$parent.$parent.logging">
							<option value="" style="display:none" disabled>Nothing selected</option>
							<option value="0">None</option>
							<option value="1">Minimal</option>
							<option value="2">Medium</option>
							<option value="3">Full</option>
						</select>
						<span class="pull-right form-control-static">Logging level&nbsp;</span>
					</div>
				</div>
				</div>




				<div class="col-md-12 col-lg-6">
					<h3>
						<span class="fas fa-caret-down pull-right collapse-control rotate-on-collapse" data-toggle="collapse" collapse-control data-target="#collapseVars" aria-expanded="true" small title="Hide/Show"></span>
						Variables
					</h3>
					<div class="collapse in" collapse-target id="collapseVars">

					<div multicolumn>
						<label var ng-if="piston && piston.v">Local variables</label>
						<div ng-if="localVars" var ng-repeat="var in piston.v"><span><span class="vartype">{{var.t}}</span><span>{{var.n}}</span> <i class="clickable far fa-edit" aria-hidden="true" ng-if="!var.v && (var.t.substr(-1) != ']')" ng-click="editLocalVariable(var)"></i></span><span class="{{var.v == null ? 'notset' : ''}}" ng-bind-html="var.v ? renderOperand(var.v) : formatVariableValue(var, var.n)"></span></div>
						<div novar>(no variables defined)</div>
						<label var ng-if="globalVars">Global variables</label>
						<div ng-if="globalVars" var ng-repeat="(name, var) in globalVars"><span><span class="vartype">{{var.t}}</span><span>{{name}}</span></span><span class="{{var.v == null ? 'notset' : ''}}" ng-bind-html="formatVariableValue(var)"></span></div>
						<div novar>(no variables defined)</div>
						<label var>System variables</label>
						<div var ng-repeat="i in systemVarNames" ng-if="(!systemVars[i].d || (systemVars[i].v != null)) && (!i.startsWith('$current')) && (!i.startsWith('$previous'))"><span><span class="vartype">{{systemVars[i].t}}</span><span>{{i}}</span></span><span class="{{systemVars[i].v == null ? 'notset' : ''}}" ng-bind-html="formatVariableValue(systemVars[i], i)"></span></div>
					</div>
				</div>
			</div>
			</div>


			<div class="row">
				<div class="col-md-12">
					<h3>
						<span class="fas fa-caret-down pull-right collapse-control rotate-on-collapse" data-toggle="collapse" collapse-control data-target="#collapseCons" aria-expanded="true" small title="Hide/Show"></span>
						Evaluation Console
					</h3>
					<div class="collapse in" collapse-target id="collapseCons">
					<console ng-if="initialized" mode="{{mode}}">
						<label>Evaluation console</label>
						<content>
							<eval ng-repeat="eval in evals"><span>({{eval.type}}) {{eval.text}} »»» </span><span ng-bind-html="eval.eval"></span></eval>
						</content>
						<footer>
							<div>
								<select ng-model="$parent.$parent.$parent.evalType"><option value="v">Value</option><option value="e">Expression</option></select>
								<input type="text" ng-model="$parent.$parent.$parent.evalText" placeholder="Enter {{evalType == 'e' ? 'an expression' : 'a value'}} to evaluate and hit Enter" ng-keypress="onEvalKeyPress($event)" ng-keydown="onEvalKeyDown($event)"/>
							</div>
						</footer>
					</console>
				</div>
			</div>
			</div>
			<div class="row" ng-if="!mobile && stats && stats.timing && stats.timing.length">
				<div class="col-md-12">

					<h3>
						<span class="fas fa-caret-down pull-right collapse-control rotate-on-collapse" collapse-control data-toggle="collapse" data-target="#collapseStats" aria-expanded="true" small title="Hide/Show"></span>
						Statistics
					</h3>
					<div class="collapse in" collapse-target id="collapseStats">
					<canvas id="line" height="100" class="chart chart-line" chart-data="chart.data" chart-labels="chart.labels" chart-series="chart.series" chart-options="chart.options" chart-dataset-override="chart.datasetOverride" disabled-chart-click_ed="chart.onClick"></canvas>
				</div>
			</div>
			</div>
		</div>
		<footer>
			<p></p>
		</footer>

	<piston id="editor" console="{{view.console}}" ng-if="initialized && (mode=='edit')" mode="{{mode}}" ng-repeat="piston in [piston]" data-nag-model="piston" ng-include="'piston'" movable="{{(mode=='edit') && view.movable}}" context-menu="contextMenu()" context-menu-class="contextmenu"></piston>
	<console ng-if="(mode == 'edit') && view.console && initialized" mode="{{mode}}">
		<label>Evaluation console</label>
		<content>
			<eval ng-repeat="eval in evals"><span>({{eval.type}}) {{eval.text}} »»» </span><span ng-bind-html="eval.eval"></span></eval>
		</content>
		<footer>
			<div>
				<select ng-model="$parent.$parent.evalType"><option value="v">Value</option><option value="e">Expression</option></select>
				<input type="text" ng-model="$parent.$parent.evalText" placeholder="Enter {{evalType == 'e' ? 'an expression' : 'a value'}} to evaluate and hit Enter" ng-keypress="onEvalKeyPress($event)" ng-keydown="onEvalKeyDown($event)"/>
			</div>
		</footer>
	</console>
	<toolbar ng-if="initialized && (mode=='edit')">
		<panel ng-if="selectionType && selection">
			<label>Properties</label>
			<table properties ng-if="selection">
				<tr ng-if="(selectionType == 'statement') && (selection.t == 'switch')">
					<td>Case Traversal Policy</td>
					<td><select ng-model="selection.ctp"><option value="i" style="color: #999">Safe</option><option value="e">Fall-through</option></select>
				</tr>
				<tr>
					<td>Description</td>
					<td><input type="text" ng-model="selection.z">
				</tr>
				<tr ng-if="selectionType == 'statement'">
					<td>Disabled</td>
					<td><select ng-model="selection.di"><option ng-value="true">Yes</option><option ng-value="false" style="color: #999">No</option><option ng-value="" style="display:none" disabled>No</option></select>
				</tr>
				<tr ng-if="(selectionType == 'statement') && (selection.t != 'on') && (selection.t != 'every')">
					<td>Execution Method</td>
					<td><select ng-model="selection.a"><option value="0" style="color: #999">Synchronous</option><option value="1">Asynchronous</option></select>
				</tr>
				<tr ng-if="(selectionType == 'condition')">
					<td>Subscription Method</td>
					<td><select ng-model="selection.sm"><option value="auto" style="color: #999">Auto</option><option value="always">Always</option><option value="never">Never</option></select>
				</tr>
				<tr ng-if="(selectionType == 'statement') && (selection.t != 'on')">
					<td>Task Cancellation Policy</td>
					<td><select ng-model="selection.tcp"><option value="">Never</option><option value="c" style="color: #999">On condition state</option><option value="p">On piston state</option><option value="b">On condition or piston state</option></select>
				</tr>
				<tr ng-if="(selectionType == 'statement') && (selection.t != 'on')">
					<td>Task Execution Policy</td>
					<td><select ng-model="selection.tep"><option value="" style="color: #999">Always</option><option value="c">On condition state</option><option value="p">On piston state</option><option value="b">On condition or piston state</option></select>
				</tr>
				<tr ng-if="(selectionType == 'statement') && (selection.t == 'action')">
					<td>Task Scheduling Policy</td>
					<td><select ng-model="selection.tsp"><option value="" style="color: #999">Override</option><option value="a">Allow multiple</option></select>
				</tr>
			</table>
		</panel>
		<panel>
			<label>Global variables</label>
			<a ng-repeat="(name, var) in globalVars" ng-click="editGlobalVariable(name);"><span typ>{{var.t}}</span> <span var>{{name}}</span><span pun> = </span><span ng-bind-html="formatVariableValue(var)"></span><span pun>;</span></a>
			<a ng-click="addGlobalVariable()"><span new>+ add a new global variable</span></a>
		</panel>
		<panel>
			<label>Devices</label>
			<div ng-repeat="device in devices" dev ng-bind-html="renderDevice(device);"></div>
		</panel>
	</toolbar>
</viewer>

<!-- Begin script -->

<script type="text/ng-template" id="piston-editor-buttons">
	<button class="btn btn-default" ng-click="edit();" title="Edit the piston">Edit</button>
	<button class="btn btn-warning" ng-click="test();" title="Test the piston">Test</button>
	<button class="btn btn-success" ng-click="snapshot(true);" title="Take an anonymized snapshot of the piston"><i class="fas fa-camera" data-fa-transform="grow-4"></i></button>
	<button class="btn btn-danger" ng-click="snapshot();" title="Take a snapshot of the piston"><i class="fas fa-camera" data-fa-transform="grow-4"></i></button>
	<button class="btn btn-default" ng-click="textSnapshot();" title="Copy piston to clipboard"><i class="fal fa-copy" data-fa-transform="grow-4"></i></button>
	<toggle ng-if="trace && trace.points" ng-model="view.trace" on="Trace" off="Trace" ng-click="toggleView(null)"></toggle>
	<button class="btn btn-danger" ng-click="deleteDialog();">Delete</button>
</script>

<script type="text/ng-template" id="dialog-captured-image">
	<br/>
	<center>
		<span ng-if="mobile">Please tap and hold the picture below to save it to your Photo Gallery. On 3D Touch enabled devices, hard press on the image to save it. On all others, tap the image to open it in a new tab and save it from there</span>
		<span ng-if="!mobile">Please right click on the picture below and copy or save it to a file.</span>
	</center>
	<dnd-nodrag>
		<img ng-if="mobile" draggable="false" id="capturedImage" src="{{capturedImage}}" onclick="window.open(this.src);" dnd-nodrag/>
		<img ng-if="!mobile" draggable="false" id="capturedImage" src="{{capturedImage}}" dnd-nodrag/>
	</dnd-nodrag>
</script>



<script type="text/ng-template" id="piston">
	<gutter></gutter>
	<tracer></tracer>
	<i data-fa-symbol="drag-handle" class="fas fa-sort svg-inline--fa"></i>
	<content>
		<line com h ng-if="piston.loading">loading piston "{{meta.name}}"...</line>
		<line com h ng-if-start="!piston.loading">/**************************************************************/</line>
		<line com h ng-click="editSettings();">{{padComment(meta.name, 64)}}</line>
		<line com h>/**************************************************************/</line>
		<line com h>{{padComment('Author     : ' + (meta.author ? meta.author : '(unknown)'), 64)}}</line>
		<line com h>{{padComment('Created    : ' + utcToString(meta.created), 64)}}</line>
		<line com h>{{padComment('Modified   : ' + utcToString(meta.modified), 64)}}</line>
		<line com h>{{padComment('Build      : ' + meta.build, 64)}}</line>
		<line com h>{{padComment('UI version : ' + version(), 64)}}</line>
		<line com h>/**************************************************************/</line>
		<line com h ng-if-start="view.exportBin">{{padComment('To import this piston, use the import code below:', 64)}}</line>
		<line com h>{{padComment('', 64)}}</line>
		<line com h exportBin="{{view.exportBin}}">{{padComment('', 64)}}</line>
		<line com h>{{padComment('', 64)}}</line>
		<line com h ng-if-end>/**************************************************************/</line>
		<line>&nbsp;</line>
		<line kwd ng-if-start="((mode == 'edit') && view.settings) || piston.o.pep || piston.o.cto || piston.o.ced || piston.o.mps || piston.o.dco || piston.o.des || piston.o.aps" ng-click="editSettings();">settings</line>
		<container>
			<line kwd ng-if="piston.o.pep">enable parallelism<span pun>;</span></line>
			<line kwd ng-if="piston.o.mps">disable automatic piston state<span pun>;</span></line>
			<line kwd ng-if="piston.o.dco">disable command optimization<span pun>;</span></line>
			<line kwd ng-if="piston.o.cto">disable condition traversal optimizations<span pun>;</span></line>
			<line kwd ng-if="piston.o.des">disable event subscriptions<span pun>;</span></line>
			<line kwd ng-if="piston.o.ced">set command execution delay to {{piston.o.ced}}ms<span pun>;</span></line>
			<line kwd ng-if="piston.o.aps">allow pre-scheduled tasks to execute during restrictions<span pun>;</span></line>
		</container>
		<line kwd>end settings;</line>
		<line ng-if-end>&nbsp;</line>
		<trace ng-if-start="(mode == 'view') && view.trace && trace && trace.t"><span>+0ms</span><span timer>start</span></trace>
		<line trace com>/* Trace started on {{utcToString(trace.t)}} (about {{timeSince(trace.t)}}) */</line>
		<line trace ng-if-end>&nbsp;</line>
		<line kwd ng-if-start="((mode=='edit') && view.variables) || (piston.v && piston.v.length)">define</line>
		<variables dnd-list="piston.v" dnd-allowed-types="['variable']" data-ng-repeat="variables in [piston.v]" data-ng-include="'variables'" dnd-nodrag></variables>
		<line kwd>end define;</line>
		<line ng-if-end>&nbsp;</line>
		<line com ng-if="piston.z">/* {{piston.z}} */</line>
		<line kwd ng-if="((mode=='edit') && view.restrictions) || (piston.r && piston.r.length)">only when</line>
		<restrictions ng-if="((mode=='edit') && view.restrictions) || (piston.r && piston.r.length)" data-ng-repeat="collection in [piston]" data-ng-include="'restrictions'" dnd-nodrag data-nag-model="statement"></restrictions>
		<line kwd>execute</line>
		<statements dnd-list="piston.s" dnd-allowed-types="['statement']" data-nag-model="piston.s" data-ng-repeat="statements in [piston.s]" data-ng-include="'statements'" exec="{{piston && piston.s && piston.s.length && trace && trace.points && !!trace.points['s:' + piston.s[0].$]}}"></statements>
		<trace ng-if="view.trace && trace && trace.points && trace.points['end']"><span>+{{trace.points['end'].o}}ms</span><span timer ok="true">done</span></trace>
		<line kwd ng-if-end>end execute;</line>
		<line trace ng-if-start="(mode == 'view') && view.trace && trace && trace.t">&nbsp;</line>
		<trace ng-if="view.trace"><span>+{{trace.d}}ms</span><span timer>stop</span></trace>
		<line trace com ng-if-end>/* Trace ended on {{utcToString(trace.t + trace.d)}} */</line>
	</content>
</script>



<script type="text/ng-template" id="variables">
			<div ng-repeat="variable in variables">
				<line com ng-if="variable.z">/* {{variable.z}} */</line>
				<line pun dnd-nodrag dnd-draggable="variable" dnd-type="'variable'" dnd-moved="drag(variables, $index);" dnd-copied="copyVariable(variables, $index)" dnd-effect-allowed="copyMove">
					<handle dnd-handle><svg class="sprite-icon"><use xlink:href="#drag-handle"></use></svg></handle>
					<span ng-click="editVariable(variable);" dnd-nodrag><span pun ng-if="(variable.a == 's') && (variable.v)">const&nbsp;</span><span typ>{{variable.t}}&nbsp;</span><span var>{{variable.n}}</span><span ng-if="variable.v" pun>&nbsp;=&nbsp;</span><span ng-if="variable.v" ng-bind-html="variable.$$html || (variable.$$html = renderOperand(variable.v))"></span><span pun>;</span><span ng-if="!variable.v" com sensitive>&nbsp;/* <span ng-bind-html="formatVariableValue(variable, variable.n)"></span> */</span></span>
				</line>
			</div>
			<line new data-ng-click="addVariable()">+ add a new variable</line>
</script>


<script type="text/ng-template" id="statements">
	<statement data-ng-repeat="statement in statements" data-ng-include="'statement'" dnd-nodrag dnd-draggable="statement" dnd-type="'statement'" dnd-moved="drag(statements, $index);" dnd-effect-allowed="copyMove" type="{{statement.t}}" show-bar="{{(statement.t != 'action') || ((statement.d) && (statement.d.length)) || ((statement.r) && (statement.r.length)) || ((statement.k) && (statement.k.length==0)) ? 'true' : 'false'}}"></statement>
	<line new data-ng-click="addStatement(statements)">+ add a new statement</line>
</script>
<script type="text/ng-template" id="statement">
	<dnd-nodrag ng-selected="selection == statement" ng-disabled="statement.di">
		<async ng-if="(statement.a == '1')" class="fa fa-code-branch" title="This statement is executed asynchronously"></async>
		<bar ng-if="(statement.t!='action') || ((mode=='edit') && view.movable) || ((statement.d) && (statement.d.length)) || ((statement.r) && (statement.r.length)) || ((statement.k) && ((mode=='edit') || (statement.k.length>1)))" asynch="{{statement.a == '1'}}"></bar>
<!--		<trace ng-if="(view.trace && (mode=='view') && trace && trace.points && trace.points['s:' + statement.$])"><span>+{{trace.points['s:' + statement.$].o}}ms</span><span dur>{{trace.points['s:' + statement.$].d}}ms</span></trace>-->
		<trace ng-if="(view.trace && (mode=='view') && ((statement.t != 'action') || (statement.d && statement.d.length)) && trace && trace.points && trace.points['s:' + statement.$])"><span>+{{trace.points['s:' + statement.$].o}}ms</span><span ng-if="(trace.points['s:' + statement.$].v != null) && (trace.points['s:' + statement.$].v >= 0)" dur>{{trace.points['s:' + statement.$].d}}ms</span><span ng-if="(trace.points['s:' + statement.$].v == null) || (trace.points['s:' + statement.$].v < 0)" timer ok="{{(trace.points['s:' + statement.$].v == null) || (trace.t + trace.points['s:' + statement.$].o + trace.points['s:' + statement.$].d - trace.points['s:' + statement.$].v >= currentTime())}}">{{trace.points['s:' + statement.$].v == null ? '▼ ▼ ▼' : timeCounter(trace.t + trace.points['s:' + statement.$].o + trace.points['s:' + statement.$].d - trace.points['s:' + statement.$].v)}}</span></trace>
		<!--action-->
		<div no-drag class="no-drag" ng-if="statement.t=='action'" no-drag>
			<line com ng-if="statement.z">/* {{statement.z}} */</line>
			<line warn ng-repeat="w in statement.w">WARNING: {{w}}</line>
			<line kwd ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)">only when</line>
			<restrictions ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)" data-ng-repeat="collection in [statement]" data-ng-include="'restrictions'" dnd-nodrag data-nag-model="statement"></restrictions>
			<line ng-if-start="((mode=='edit') && view.movable) || ((statement.d) && (statement.d.length)) || ((statement.r) && (statement.r.length)) || ((statement.k) && (statement.k.length==0))" kwd ng-click="select(statement, statements)">
				<handle dnd-handle><svg class="sprite-icon"><use xlink:href="#drag-handle"></use></svg></handle><span ng-click="editStatement(statement, statements)" kwd>{{statement.a == '1' ? 'async ' : ''}}with</span>
				<badge green ng-if="(statement.tep == 'c')" badge="C" title="Only execute on condition state change"></badge>
				<badge green ng-if="(statement.tep == 'p')" badge="P" title="Only execute on piston state change"></badge>
				<badge green ng-if="(statement.tep == 'b')" badge="C|P" title="Only execute on condition or piston state change"></badge>
				<badge red ng-if="(statement.tcp != 'c') && (statement.tcp != 'p') && (statement.tcp != 'b')" badge="N" title="Never cancel"></badge>
				<badge red ng-if="(statement.tcp == 'p')" badge="P" title="Cancel on piston state change"></badge>
				<badge red ng-if="(statement.tcp == 'b')" badge="C|P" title="Cancel on condition or piston state change"></badge>
				<badge blue ng-if="statement.tsp == 'a'" badge="A" title="Allow multiple schedules"></badge>
				<span ng-if="view.trace && (mode=='view')" nul> /* #{{statement.$}} */</span>
			</line>
			<container>
				<line><span ng-click="editStatement(statement, statements);" ng-attr-invalid="{{(!statement.d) || (!statement.d.length)}}" ng-bind-html="renderDeviceNameList(statement.d)"></span></line>
			</container>
			<line kwd ng-click="select(statement, statements)">do</line>
			<tasks dnd-list="statement.k" dnd-allowed-types="['task']" data-ng-repeat="tasks in [statement.k]" data-nag-model="statement.k" data-ng-include="'tasks'"></tasks>
			<line ng-if-end kwd ng-click="select(statement, statements)">end with;</line>
			<task ng-if="!(((mode=='edit') && view.movable) || ((statement.d) && (statement.d.length)) || ((statement.r) && (statement.r.length)) || ((statement.k) && (statement.k.length==0)))" data-ng-repeat="task in statement.k" data-ng-include="'task'" dnd-nodrag dnd-draggable="task" dnd-type="'task'" dnd-moved="drag(statement.k, $index);" dnd-effect-allowed="copyMove"></task>
			<line ng-if="!(((mode=='edit') && view.movable) || ((statement.d) && (statement.d.length)) || ((statement.r) && (statement.r.length)) || ((statement.k) && (statement.k.length==0)))" new data-ng-click="addTask(statement)">+ add a new task</line>
		</div>

		<!--do-->
		<div no-drag class="no-drag" ng-if="statement.t=='do'" no-drag>
			<line com ng-if="statement.z">/* {{statement.z}} */</line>
			<line warn ng-repeat="w in statement.w">WARNING: {{w}}</line>
			<line kwd ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)">only when</line>
			<restrictions ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)" data-ng-repeat="collection in [statement]" data-ng-include="'restrictions'" dnd-nodrag data-nag-model="statement"></restrictions>
			<line kwd ng-click="select(statement, statements)">
				<handle dnd-handle><svg class="sprite-icon"><use xlink:href="#drag-handle"></use></svg></handle><span ng-click="editStatement(statement, statements)" kwd>{{statement.a == '1' ? 'async ' : ''}}do</span>
				<badge green ng-if="(statement.tep == 'c')" badge="C" title="Only execute on condition state change"></badge>
				<badge green ng-if="(statement.tep == 'p')" badge="P" title="Only execute on piston state change"></badge>
				<badge green ng-if="(statement.tep == 'b')" badge="C|P" title="Only execute on condition or piston state change"></badge>
				<badge red ng-if="(statement.tcp != 'c') && (statement.tcp != 'p') && (statement.tcp != 'b')" badge="N" title="Never cancel"></badge>
				<badge red ng-if="(statement.tcp == 'p')" badge="P" title="Cancel on piston state change"></badge>
				<badge red ng-if="(statement.tcp == 'b')" badge="C|P" title="Cancel on condition or piston state change"></badge>
				<badge blue ng-if="statement.tsp == 'a'" badge="A" title="Allow multiple schedules"></badge>
				<span ng-if="view.trace && (mode=='view')" nul> /* #{{statement.$}} */</span>
			</line>
			<statements ng-if="(mode=='edit') || (statement.s && statement.s.length)" dnd-list="statement.s" dnd-allowed-types="['statement']" data-ng-repeat="statements in [statement.s]" data-ng-include="'statements'" dnd-nodrag data-nag-model="statement.s" exec="{{statement && statement.s && statement.s.length && trace && trace.points && !!trace.points['s:' + statement.s[0].$]}}"></statements>
			<line ng-if-end kwd ng-click="select(statement, statements)">end do;</line>
		</div>


		<!--on-->
		<div no-drag class="no-drag" ng-if="statement.t=='on'" no-drag>
			<line com ng-if="statement.z">/* {{statement.z}} */</line>
			<line warn ng-repeat="w in statement.w">WARNING: {{w}}</line>
			<line kwd ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)">only when</line>
			<restrictions ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)" data-ng-repeat="collection in [statement]" data-ng-include="'restrictions'" dnd-nodrag data-nag-model="statement"></restrictions>
			<line kwd ng-click="select(statement, statements)">
				<handle dnd-handle><svg class="sprite-icon"><use xlink:href="#drag-handle"></use></svg></handle><span ng-click="editStatement(statement, statements)" kwd>on events from</span>
				<span ng-if="view.trace && (mode=='view')" nul> /* #{{statement.$}} */</span>
			</line>
			<events data-ng-repeat="collection in [statement]" data-ng-include="'events'" dnd-nodrag eval="{{statement && trace && trace.points && trace.points['c:' + statement.$] ? trace.points['c:' + statement.$].v : ''}}"></events>
			<line kwd ng-click="select(statement, statements)">do</line>
			<statements ng-if="(mode=='edit') || (statement.s && statement.s.length)" dnd-list="statement.s" dnd-allowed-types="['statement']" data-ng-repeat="statements in [statement.s]" data-ng-include="'statements'" dnd-nodrag data-nag-model="statement.s" exec="{{statement && statement.s && statement.s.length && trace && trace.points && !!trace.points['s:' + statement.s[0].$]}}"></statements>
			<line ng-if-end kwd ng-click="select(statement, statements)">end on;</line>
		</div>

		<!--if-->
		<div no-drag class="no-drag" ng-if="statement.t=='if'" no-drag>
			<line com ng-if="statement.z">/* {{statement.z}} */</line>
			<line warn ng-repeat="w in statement.w">WARNING: {{w}}</line>
			<line kwd ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)">only when</line>
			<restrictions ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)" data-ng-repeat="collection in [statement]" data-ng-include="'restrictions'" dnd-nodrag data-nag-model="statement"></restrictions>
			<line kwd ng-click="select(statement, statements)">
				<handle dnd-handle><svg class="sprite-icon"><use xlink:href="#drag-handle"></use></svg></handle><span ng-click="editStatement(statement, statements)" kwd>{{statement.a == '1' ? 'async ' : ''}}if</span>
				<badge green ng-if="(statement.tep == 'c')" badge="C" title="Only execute on condition state change"></badge>
				<badge green ng-if="(statement.tep == 'p')" badge="P" title="Only execute on piston state change"></badge>
				<badge green ng-if="(statement.tep == 'b')" badge="C|P" title="Only execute on condition or piston state change"></badge>
				<badge red ng-if="(statement.tcp != 'c') && (statement.tcp != 'p') && (statement.tcp != 'b')" badge="N" title="Never cancel"></badge>
				<badge red ng-if="(statement.tcp == 'p')" badge="P" title="Cancel on piston state change"></badge>
				<badge red ng-if="(statement.tcp == 'b')" badge="C|P" title="Cancel on condition or piston state change"></badge>
				<badge blue ng-if="statement.tsp == 'a'" badge="A" title="Allow multiple schedules"></badge>
				<span ng-if="view.trace && (mode=='view')" nul> /* #{{statement.$}} */</span>
			</line>
			<conditions data-ng-repeat="collection in [statement]" data-ng-include="'conditions'" dnd-nodrag data-nag-model="statement" eval="{{statement && trace && trace.points && trace.points['c:' + statement.$] ? trace.points['c:' + statement.$].v : ''}}"></conditions>
			<line kwd ng-if="(mode=='edit') || (statement.s && statement.s.length)" ng-click="select(statement, statements)">then</line>
			<statements ng-if="(mode=='edit') || (statement.s && statement.s.length)" dnd-list="statement.s" dnd-allowed-types="['statement']" data-ng-repeat="statements in [statement.s]" data-ng-include="'statements'" dnd-nodrag data-nag-model="statement.s" exec="{{statement && statement.s && statement.s.length && trace && trace.points && !!trace.points['s:' + statement.s[0].$]}}"></statements>
			<line kwd ng-if="(mode=='edit') || (statement.ei && statement.ei.length)" ng-repeat-start="elseIf in statement.ei" ng-click="select(statement, statements)">else if</line>
			<conditions ng-if="(mode=='edit') || (statement.ei && statement.ei.length)" data-ng-repeat="collection in [elseIf]" data-ng-include="'conditions'" ng-init="parentCollection = elseIf" dnd-nodrag data-nag-model="elseIf" eval="{{elseIf && trace && trace.points && trace.points['c:' + elseIf.$] ? trace.points['c:' + elseIf.$].v : ''}}"></conditions>
			<line kwd ng-if="(mode=='edit') || (statement.ei && statement.ei.length)" ng-click="select(statement, statements)">then</line>
			<statements ng-if="(mode=='edit') || (statement.ei && statement.ei.length)" dnd-list="elseIf.s" dnd-allowed-types="['statement']" ng-repeat-end data-ng-repeat="statements in [elseIf.s]" data-ng-include="'statements'" dnd-nodrag data-nag-model="elseIf.s" exec="{{elseIf && elseIf.s && elseIf.s.length && trace && trace.points && !!trace.points['s:' + elseIf.s[0].$]}}"></statements>
			<line ng-if-start="(mode=='edit') && view.elseIfs" kwd>else if</line>
			<conditions ng-if-end>
				<line new data-ng-click="addCondition(statement.ei, true, null, statement.o)">+ add a new condition</line>
			</conditions>
			<line kwd ng-if="(mode=='edit') || (statement.e && statement.e.length)" ng-click="select(statement, statements)">else</line>
			<statements ng-if="(mode=='edit') || (statement.e && statement.e.length)" dnd-list="statement.e" dnd-allowed-types="['statement']" data-ng-repeat="statements in [statement.e]" data-ng-include="'statements'" dnd-nodrag data-nag-model="statement.e"  exec="{{statement && statement.e && statement.e.length && trace && trace.points && !!trace.points['s:' + statement.e[0].$]}}"></statements>
			<line kwd ng-click="select(statement, statements)">end if;</line>
		</div>

		<!--switch-->
		<div no-drag class="no-drag" ng-if="statement.t=='switch'">
			<line com ng-if="statement.z">/* {{statement.z}} */</line>
			<line warn ng-repeat="w in statement.w">WARNING: {{w}}</line>
			<line kwd ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)">only when</line>
			<restrictions ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)" data-ng-repeat="collection in [statement]" data-ng-include="'restrictions'" dnd-nodrag data-nag-model="statement"></restrictions>
			<line kwd ng-click="select(statement, statements)">
				<handle dnd-handle><svg class="sprite-icon"><use xlink:href="#drag-handle"></use></svg></handle><span ng-click="editStatement(statement, statements)" kwd>{{statement.a == '1' ? 'async ' : ''}}switch</span> <span pun>(</span><span ng-bind-html="statement.$$html || (statement.$$html = renderOperand(statement.lo))"></span><span pun>)</span><span pun title="Fall-through mode" ng-if="statement.ctp == 'e'"><i class="fas fa-sort-amount-asc"></i></span>
				<badge green ng-if="(statement.tep == 'c')" badge="C" title="Only execute on condition state change"></badge>
				<badge green ng-if="(statement.tep == 'p')" badge="P" title="Only execute on piston state change"></badge>
				<badge green ng-if="(statement.tep == 'b')" badge="C|P" title="Only execute on condition or piston state change"></badge>
				<badge red ng-if="(statement.tcp != 'c') && (statement.tcp != 'p') && (statement.tcp != 'b')" badge="N" title="Never cancel"></badge>
				<badge red ng-if="(statement.tcp == 'p')" badge="P" title="Cancel on piston state change"></badge>
				<badge red ng-if="(statement.tcp == 'b')" badge="C|P" title="Cancel on condition or piston state change"></badge>
				<badge blue ng-if="statement.tsp == 'a'" badge="A" title="Allow multiple schedules"></badge>
				<span ng-if="view.trace && (mode=='view')" nul> /* #{{statement.$}} */</span>
			</line>
			<container>
				<cases>
					<line com ng-repeat-start="case in statement.cs"  ng-if="case.z">/* {{case.z}} */</line>
					<line kwd ng-if="(mode=='edit') || (statement.cs && statement.cs.length)" ng-click="select(case, statement.cs, 'case')"><span kwd  ng-click="editCase(case, statement.cs);">case</span> <span ng-click="editCase(case, statement.cs);" ng-bind-html="case.$$html || (case.$$html = renderOperand(case.ro))"></span><span ng-if-start="case.t == 'r'" pun> through </span><span ng-if-end ng-bind-html="case.$$html2 || (case.$$html2 = renderOperand(case.ro2))"></span><span pun>:</span></line>
					<statements ng-if="(mode=='edit') || (statement.cs && statement.cs.length)" ng-repeat-end dnd-list="case.s" dnd-allowed-types="['statement']" data-ng-repeat="statements in [case.s]" data-ng-include="'statements'" dnd-nodrag data-nag-model="case.s"></statements>
					<line kwd ng-if-start="mode=='edit'">case</line>
					<container ng-if-end>
						<line new data-ng-click="addCase(statement.cs)">+ add a new case</line>
					</container>
					<line kwd ng-if-start="(mode=='edit') || (statement.e && statement.e.length)" ng-click="select(statement, statements)">default <span pun>:</span></line>
					<statements ng-if-end dnd-list="statement.e" dnd-allowed-types="['statement']" data-ng-repeat="statements in [statement.e]" data-ng-include="'statements'" dnd-nodrag data-nag-model="statement.e"></statements>
				</cases>
			</container>
			<line kwd ng-click="select(statement, statements)">end switch;</line>
		</div>

		<!--for-->
		<div no-drag class="no-drag" ng-if="statement.t=='for'">
			<line com ng-if="statement.z">/* {{statement.z}} */</line>
			<line warn ng-repeat="w in statement.w">WARNING: {{w}}</line>
			<line kwd ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)">only when</line>
			<restrictions ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)" data-ng-repeat="collection in [statement]" data-ng-include="'restrictions'" dnd-nodrag data-nag-model="statement"></restrictions>
			<line kwd ng-click="select(statement, statements)">
				<handle dnd-handle><svg class="sprite-icon"><use xlink:href="#drag-handle"></use></svg></handle><span ng-click="editStatement(statement, statements)" kwd>{{statement.a == '1' ? 'async ' : ''}}for</span> <span pun>(</span><span ng-bind-html="statement.$$html || (statement.$$html = renderForOperands(statement))"></span><span pun>)</span>
				<badge green ng-if="(statement.tep == 'c')" badge="C" title="Only execute on condition state change"></badge>
				<badge green ng-if="(statement.tep == 'p')" badge="P" title="Only execute on piston state change"></badge>
				<badge green ng-if="(statement.tep == 'b')" badge="C|P" title="Only execute on condition or piston state change"></badge>
				<badge red ng-if="(statement.tcp != 'c') && (statement.tcp != 'p') && (statement.tcp != 'b')" badge="N" title="Never cancel"></badge>
				<badge red ng-if="(statement.tcp == 'p')" badge="P" title="Cancel on piston state change"></badge>
				<badge red ng-if="(statement.tcp == 'b')" badge="C|P" title="Cancel on condition or piston state change"></badge>
				<badge blue ng-if="statement.tsp == 'a'" badge="A" title="Allow multiple schedules"></badge>
				<span ng-if="view.trace && (mode=='view')" nul> /* #{{statement.$}} */</span>
			</line>
			<line kwd ng-click="select(statement, statements)">do</line>
			<statements dnd-list="statement.s" dnd-allowed-types="['statement']" data-ng-repeat="statements in [statement.s]" data-ng-include="'statements'" dnd-nodrag data-nag-model="statement.s"></statements>
			<line kwd ng-click="select(statement, statements)">end for;</line>
		</div>

		<!--each-->
		<div no-drag class="no-drag" ng-if="statement.t=='each'">
			<line com ng-if="statement.z">/* {{statement.z}} */</line>
			<line warn ng-repeat="w in statement.w">WARNING: {{w}}</line>
			<line kwd ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)">only when</line>
			<restrictions ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)" data-ng-repeat="collection in [statement]" data-ng-include="'restrictions'" dnd-nodrag data-nag-model="statement"></restrictions>
			<line kwd ng-click="select(statement, statements)">
				<handle dnd-handle><svg class="sprite-icon"><use xlink:href="#drag-handle"></use></svg></handle><span ng-click="editStatement(statement, statements)" kwd>{{statement.a == '1' ? 'async ' : ''}}for each</span> <span pun>(</span><span ng-bind-html="statement.$$html || (statement.$$html = renderForEachOperands(statement))"></span><span pun>)</span>
				<badge green ng-if="(statement.tep == 'c')" badge="C" title="Only execute on condition state change"></badge>
				<badge green ng-if="(statement.tep == 'p')" badge="P" title="Only execute on piston state change"></badge>
				<badge green ng-if="(statement.tep == 'b')" badge="C|P" title="Only execute on condition or piston state change"></badge>
				<badge red ng-if="(statement.tcp != 'c') && (statement.tcp != 'p') && (statement.tcp != 'b')" badge="N" title="Never cancel"></badge>
				<badge red ng-if="(statement.tcp == 'p')" badge="P" title="Cancel on piston state change"></badge>
				<badge red ng-if="(statement.tcp == 'b')" badge="C|P" title="Cancel on condition or piston state change"></badge>
				<badge blue ng-if="statement.tsp == 'a'" badge="A" title="Allow multiple schedules"></badge>
				<span ng-if="view.trace && (mode=='view')" nul> /* #{{statement.$}} */</span>
			</line>
			<line kwd ng-click="select(statement, statements)">do</line>
			<statements dnd-list="statement.s" dnd-allowed-types="['statement']" data-ng-repeat="statements in [statement.s]" data-ng-include="'statements'" dnd-nodrag data-nag-model="statement.s"></statements>
			<line kwd ng-click="select(statement, statements)">end for each;</line>
		</div>

		<!--while-->
		<div no-drag class="no-drag" ng-if="statement.t=='while'">
			<line com ng-if="statement.z">/* {{statement.z}} */</line>
			<line warn ng-repeat="w in statement.w">WARNING: {{w}}</line>
			<line kwd ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)">only when</line>
			<restrictions ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)" data-ng-repeat="collection in [statement]" data-ng-include="'restrictions'" dnd-nodrag data-nag-model="statement"></restrictions>
			<line kwd ng-click="select(statement, statements)">
				<handle dnd-handle><svg class="sprite-icon"><use xlink:href="#drag-handle"></use></svg></handle><span ng-click="editStatement(statement, statements)" kwd>{{statement.a == '1' ? 'async ' : ''}}while</span>
				<badge green ng-if="(statement.tep == 'c')" badge="C" title="Only execute on condition state change"></badge>
				<badge green ng-if="(statement.tep == 'p')" badge="P" title="Only execute on piston state change"></badge>
				<badge green ng-if="(statement.tep == 'b')" badge="C|P" title="Only execute on condition or piston state change"></badge>
				<badge red ng-if="(statement.tcp != 'c') && (statement.tcp != 'p') && (statement.tcp != 'b')" badge="N" title="Never cancel"></badge>
				<badge red ng-if="(statement.tcp == 'p')" badge="P" title="Cancel on piston state change"></badge>
				<badge red ng-if="(statement.tcp == 'b')" badge="C|P" title="Cancel on condition or piston state change"></badge>
				<badge blue ng-if="statement.tsp == 'a'" badge="A" title="Allow multiple schedules"></badge>
				<span ng-if="view.trace && (mode=='view')" nul> /* #{{statement.$}} */</span>
			</line>
			<conditions data-ng-repeat="collection in [statement]" data-ng-include="'conditions'" dnd-nodrag data-nag-model="statement"></conditions>
			<line kwd ng-click="select(statement, statements)">do</line>
			<statements dnd-list="statement.s" dnd-allowed-types="['statement']" data-ng-repeat="statements in [statement.s]" data-ng-include="'statements'" dnd-nodrag data-nag-model="statement.s"></statements>
			<line kwd ng-click="select(statement, statements)">end while;</line>
		</div>

		<!--repeat-->
		<div no-drag class="no-drag" ng-if="statement.t=='repeat'">
			<line com ng-if="statement.z">/* {{statement.z}} */</line>
			<line warn ng-repeat="w in statement.w">WARNING: {{w}}</line>
			<line kwd ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)">only when</line>
			<restrictions ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)" data-ng-repeat="collection in [statement]" data-ng-include="'restrictions'" dnd-nodrag data-nag-model="statement"></restrictions>
			<line ng-click="select(statement, statements)">
				<handle dnd-handle><svg class="sprite-icon"><use xlink:href="#drag-handle"></use></svg></handle><span ng-click="editStatement(statement, statements)" kwd>{{statement.a == '1' ? 'async ' : ''}}repeat</span>
				<badge green ng-if="(statement.tep == 'c')" badge="C" title="Only execute on condition state change"></badge>
				<badge green ng-if="(statement.tep == 'p')" badge="P" title="Only execute on piston state change"></badge>
				<badge green ng-if="(statement.tep == 'b')" badge="C|P" title="Only execute on condition or piston state change"></badge>
				<badge red ng-if="(statement.tcp != 'c') && (statement.tcp != 'p') && (statement.tcp != 'b')" badge="N" title="Never cancel"></badge>
				<badge red ng-if="(statement.tcp == 'p')" badge="P" title="Cancel on piston state change"></badge>
				<badge red ng-if="(statement.tcp == 'b')" badge="C|P" title="Cancel on condition or piston state change"></badge>
				<badge blue ng-if="statement.tsp == 'a'" badge="A" title="Allow multiple schedules"></badge>
				<span ng-if="view.trace && (mode=='view')" nul> /* #{{statement.$}} */</span>
			</line>
			<line kwd ng-click="select(statement, statements)">do</line>
			<statements dnd-list="statement.s" dnd-allowed-types="['statement']" data-ng-repeat="statements in [statement.s]" data-ng-include="'statements'" dnd-nodrag data-nag-model="statement.s"></statements>
			<line kwd ng-click="select(statement, statements)">until</line>
			<conditions data-ng-repeat="collection in [statement]" data-ng-include="'conditions'" dnd-nodrag data-nag-model="statement"></conditions>
			<line kwd ng-click="select(statement, statements)">end repeat;</line>
		</div>

		<!--every-->
		<div no-drag class="no-drag" ng-if="statement.t=='every'">
			<line com ng-if="statement.z">/* {{statement.z}} */</line>
			<line warn ng-repeat="w in statement.w">WARNING: {{w}}</line>
			<line kwd ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)">only when</line>
			<restrictions ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)" data-ng-repeat="collection in [statement]" data-ng-include="'restrictions'" dnd-nodrag data-nag-model="statement"></restrictions>
			<line kwd ng-click="select(statement, statements)">
				<handle dnd-handle><svg class="sprite-icon"><use xlink:href="#drag-handle"></use></svg></handle><span kwd ng-click="editStatement(statement, statements)">every</span> <span lit ng-click="editStatement(statement, statements)" ng-bind-html="renderTimer(statement);"></span>
				<badge green ng-if="(statement.tep == 'c')" badge="C" title="Only execute on condition state change"></badge>
				<badge green ng-if="(statement.tep == 'p')" badge="P" title="Only execute on piston state change"></badge>
				<badge green ng-if="(statement.tep == 'b')" badge="C|P" title="Only execute on condition or piston state change"></badge>
				<badge red ng-if="(statement.tcp != 'c') && (statement.tcp != 'p') && (statement.tcp != 'b')" badge="N" title="Never cancel"></badge>
				<badge red ng-if="(statement.tcp == 'p')" badge="P" title="Cancel on piston state change"></badge>
				<badge red ng-if="(statement.tcp == 'b')" badge="C|P" title="Cancel on condition or piston state change"></badge>
				<badge blue ng-if="statement.tsp == 'a'" badge="A" title="Allow multiple schedules"></badge>
				<span ng-if="view.trace && (mode=='view')" nul> /* #{{statement.$}} */</span>
			</line>
			<line kwd ng-click="select(statement, statements)">do</line>
			<statements dnd-list="statement.s" dnd-allowed-types="['statement']" data-ng-repeat="statements in [statement.s]" data-ng-include="'statements'" dnd-nodrag data-nag-model="statement.s"></statements>
			<line kwd ng-click="select(statement, statements)">end every;</line>
		</div>

		<!--break-->
		<div no-drag class="no-drag" ng-if="statement.t=='break'">
			<line com ng-if="statement.z">/* {{statement.z}} */</line>
			<line warn ng-repeat="w in statement.w">WARNING: {{w}}</line>
			<line kwd ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)">only when</line>
			<restrictions ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)" data-ng-repeat="collection in [statement]" data-ng-include="'restrictions'" dnd-nodrag data-nag-model="statement"></restrictions>
			<line kwd ng-click="select(statement, statements)">
				<handle dnd-handle><svg class="sprite-icon"><use xlink:href="#drag-handle"></use></svg></handle><span ng-click="editStatement(statement, statements)" kwd>break</span>
				<span ng-if="view.trace && (mode=='view')" nul> /* #{{statement.$}} */</span>
			</line>
		</div>

		<!--return-->
		<div no-drag class="no-drag" ng-if="statement.t=='exit'">
			<line com ng-if="statement.z">/* {{statement.z}} */</line>
			<line warn ng-repeat="w in statement.w">WARNING: {{w}}</line>
			<line kwd ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)">only when</line>
			<restrictions ng-if="((mode=='edit') && view.restrictions) || (statement.r && statement.r.length)" data-ng-repeat="collection in [statement]" data-ng-include="'restrictions'" dnd-nodrag data-nag-model="statement"></restrictions>
			<line kwd ng-click="select(statement, statements)">
				<handle dnd-handle><svg class="sprite-icon"><use xlink:href="#drag-handle"></use></svg></handle><span kwd ng-click="editStatement(statement, statements)">exit</span> <span lit ng-bind-html="renderOperand(statement.lo)"></span><span kwd>;</span>
				<span ng-if="view.trace && (mode=='view')" nul> /* #{{statement.$}} */</span>
			</line>
		</div>
	</dnd-nodrag>
</script>





<script type="text/ng-template" id="events">
	<dnd-nodrag ng-selected="selection && (selection.c == collection.c)">
		<bar ng-if="(mode=='edit') || (collection.c && (collection.c.length > 1))"></bar>
		<trace ng-if="(view.trace && (mode=='view') && (collection.c) && (collection.c.length > 1) && trace && trace.points && trace.points['c:' + collection.$])"><span>+{{point.o}}ms</span><span dur eval="{{trace.points['c:' + collection.$].v}}">{{point.d}}ms</span></trace>
		<div no-drag class="no-drag" dnd-list="collection.c" dnd-allowed-types="['event']" ng-selected="selection == collection">
			<line com ng-if="collection.z">/* {{collection.z}} */</line>
			<event data-ng-repeat-start="event in collection.c" data-ng-include="'event'" dnd-nodrag dnd-draggable="event" dnd-nodrag dnd-type="'event'" dnd-moved="drag(collection.c, $index);" dnd-effect-allowed="copyMove"></event>
			<line operator data-ng-repeat-end><span pun>or</span></line>
			<line new data-ng-click="addEvent(collection)">+ add a new event</line>
		</div>
	</dnd-nodrag>
</script>
<script type="text/ng-template" id="event">
	<dnd-nodrag ng-selected="selection == event">
		<div>
		<trace ng-if="(view.trace && (mode=='view') && trace && trace.points && trace.points['c:' + event.$])"><span>+{{trace.points['c:' + event.$].o}}ms</span><span dur eval="{{trace.points['c:' + event.$].v}}">{{trace.points['c:' + event.$].d}}ms</span></trace>
		<subscription ng-if="(mode == 'view') && !!event.s" class="fa fa-bolt" title="This event subscribes to events"></subscription>
		<line com ng-if="!event.c && !!event.z">/* {{event.z}} */</line>
		<line cond ng-if="!event.c" ng-click="select(event, collection.c, 'event')">
			<handle dnd-handle><svg class="sprite-icon"><use xlink:href="#drag-handle"></use></svg></handle><span ng-click="editEvent(event, collection.c);" ng-bind-html="event.$$html || (event.$$html = renderOperand(event.lo))"></span><span ng-if="view.trace && (mode=='view')" nul> /* #{{event.$}} */</span>
		</line>
		</div>
	</dnd-nodrag>
</script>






<script type="text/ng-template" id="conditions">
	<dnd-nodrag ng-selected="selection && (selection.c == collection.c)">
		<bar ng-if="(mode=='edit') || (collection.c && (collection.c.length > 1))"></bar>
		<trace ng-if="(view.trace && (mode=='view') && (collection.c) && (collection.c.length > 1) && trace && trace.points && trace.points['c:' + collection.$])"><span>+{{point.o}}ms</span><span dur eval="{{trace.points['c:' + collection.$].v}}">{{point.d}}ms</span></trace>
		<div no-drag class="no-drag" dnd-list="collection.c" dnd-allowed-types="['condition']" ng-selected="selection == collection">
			<line com ng-if="(collection.z && ((collection.t == 'group') || (collection.t == 'condition')))">/* {{collection.z}} */</line>
			<line com ng-if="(collection.zc && (collection.t != 'group') && (collection.t != 'condition'))">/* {{collection.zc}} */</line>
			<line pun data-ng-if-start="(collection.t == 'group') || !!collection.n" ng-click="select(collection, (collection.t == 'group' ? ($parent.$parent.parentCollection ? $parent.$parent.parentCollection.c : statement.c) : null), 'conditions')"><span pun ng-click="editConditionGroup(collection, (collection.t == 'group' ? ($parent.$parent.parentCollection ? $parent.$parent.parentCollection.c : statement.c) : null), (collection.t == 'group' ? ($parent.$parent.parentCollection ? $parent.$parent.parentCollection.o : statement.o) : null));">{{collection.n ? 'not ' : ''}}(</span><span ng-if="view.trace && (mode=='view')" nul> /* #{{collection.$}} */</span></line>
			<container dnd-list="collection.c" dnd-allowed-types="['condition']">
				<condition data-ng-repeat-start="condition in collection.c" ng-init="parentCollection = collection" data-ng-include="'condition'" dnd-nodrag data-nag-model="collection.c" dnd-draggable="condition" dnd-nodrag dnd-type="'condition'" dnd-moved="drag(collection.c, $index);" dnd-effect-allowed="copyMove"></condition>
				<line operator data-ng-repeat-end ng-click="select(collection, (collection.t == 'group' ? ($parent.$parent.parentCollection ? $parent.$parent.parentCollection.c : statement.c) : null), 'conditions')"><span pun data-ng-click="editConditionGroup(collection, (collection.t == 'group' ? ($parent.$parent.parentCollection ? $parent.$parent.parentCollection.c : statement.c) : null), (collection.t == 'group' ? ($parent.$parent.parentCollection ? $parent.$parent.parentCollection.o : statement.o) : null));" ng-bind-html="renderGroupingMethod(collection, condition)">{{collection.o}}</span></line>
				<line new data-ng-click="addCondition(collection, null, null, collection.o)">+ add a new condition</line>
			</container>
			<line data-ng-if-end pun>)</line>
			<condition ng-if-start="(collection.t != 'group') && !collection.n" data-ng-repeat-start="condition in collection.c" data-ng-include="'condition'" dnd-nodrag data-nag-model="collection" dnd-draggable="condition" dnd-nodrag dnd-type="'condition'" dnd-moved="drag(collection.c, $index);" dnd-effect-allowed="copyMove"></condition>
			<line operator ng-if-end data-ng-repeat-end ng-click="select({t: 'group', c: collection.c, o: collection.o, n: collection.n},  null, 'conditions')"><span pun data-ng-click="editConditionGroup(collection, null, (collection.t == 'group' ? ($parent.$parent.parentCollection ? $parent.$parent.parentCollection.o : statement.o) : null));" ng-bind-html="renderGroupingMethod(collection, condition)">{{collection.o}}</span></line>
			<line new ng-if="(collection.t != 'group') && !collection.n" data-ng-click="addCondition(collection, null, null, collection.o)">+ add a new condition</line>
		</div>
	</dnd-nodrag>
</script>
<script type="text/ng-template" id="condition">
	<dnd-nodrag ng-selected="selection == condition">
		<div>
		<trace ng-if="(view.trace && (mode=='view') && trace && trace.points && trace.points['c:' + condition.$])"><span>+{{trace.points['c:' + condition.$].o}}ms</span><span dur eval="{{trace.points['c:' + condition.$].v}}">{{trace.points['c:' + condition.$].d}}ms</span></trace>
		<subscription ng-if="(mode == 'view') && !!condition.s" class="fa fa-bolt" title="This condition subscribes to events"></subscription>
		<conditions ng-if="condition.c" ng-repeat="collection in [condition]" data-ng-include="'conditions'" dnd-nodrag data-nag-model="condition" dnd-draggable="condition" dnd-type="'condition'" dnd-moved="drag(collection.c, $index);" dnd-effect-allowed="copyMove" eval="{{collection && trace && trace.points && trace.points['c:' + collection.$] ? trace.points['c:' + collection.$].v : ''}}"></conditions>
		<line com ng-if="!condition.c && !!condition.z">/* {{condition.z}} */</line>
		<line cond ng-if="!condition.c" ng-click="select(condition, collection.c, 'condition')">
			<handle dnd-handle><svg class="sprite-icon"><use xlink:href="#drag-handle"></use></svg></handle><span ng-click="editCondition(condition, collection.c, null, null, collection.o);" ng-bind-html="condition.$$html || (condition.$$html = renderComparison(condition.lo, condition.co, condition.ro, condition.ro2, condition.to, condition.to2))"></span><span ng-if="view.trace && (mode=='view')" nul> /* #{{condition.$}} */</span>
			<badge blue ng-if="condition.sm == 'always'" badge="+" title="Always subscribe"></badge>
			<badge red ng-if="condition.sm == 'never'" badge="-" title="Never subscribe"></badge>
		</line>
		<line ng-if="!condition.c && !!condition.lo && (condition.lo.t == 'p') && !!condition.lo.dm" pun>&nbsp;&nbsp;<i class="far fa-subscript"></i> save matching devices to <span var>{{'{' + condition.lo.dm + '}'}}</span></line>
		<line ng-if="!condition.c && !!condition.lo && (condition.lo.t == 'p') && !!condition.lo.dn" pun>&nbsp;&nbsp;<i class="far fa-subscript"></i> save non-matching devices to <span var>{{'{' + condition.lo.dn + '}'}}</span></line>
		<container ng-if="((mode=='edit') && view.whens) || (condition.ts && condition.ts.length) || (condition.fs && condition.fs.length)">
			<line pun>{</line>
			<container>
				<line kwd when ng-if-start="view.whens || (condition.ts && condition.ts.length)">when true</line>
				<statements ng-if-end dnd-list="condition.ts" dnd-allowed-types="['statement']" data-ng-repeat="statements in [condition.ts]" data-ng-include="'statements'" dnd-nodrag data-nag-model="condition.ts"></statements>
				<line kwd when ng-if-start="view.whens || (condition.fs && condition.fs.length)">when false</line>
				<statements ng-if-end dnd-list="condition.fs" dnd-allowed-types="['statement']" data-ng-repeat="statements in [condition.fs]" data-ng-include="'statements'" dnd-nodrag data-nag-model="condition.fs"></statements>
			</container>
			<line pun>}</line>
		</container>
		</div>
	</dnd-nodrag>
</script>







<script type="text/ng-template" id="restrictions">
	<dnd-nodrag ng-selected="selection && (selection.r == collection.r)">
		<bar ng-if="(mode=='edit') || (collection.r && (collection.r.length > 1))"></bar>
		<trace ng-if="(view.trace && (mode=='view') && (collection.r) && (collection.r.length > 1) && trace && trace.points && trace.points['c:' + collection.$])"><span>+{{point.rop}}ms</span><span dur eval="{{trace.points['c:' + collection.$].v}}">{{point.d}}ms</span></trace>
		<div no-drag class="no-drag" dnd-list="collection.r" dnd-allowed-types="['restriction']">
			<line com ng-if="(collection.z && ((collection.t == 'group') || (collection.t == 'restriction')))">/* {{collection.z}} */</line>
			<line com ng-if="(collection.zr && (collection.t != 'group') && (collection.t != 'restriction'))">/* {{collection.zr}} */</line>
			<line pun data-ng-if-start="(collection.t == 'group') || !!collection.rn" ng-click="select(collection, (collection.t == 'group' ? ($parent.$parent.parentCollection ? $parent.$parent.parentCollection.r : (statement ? statement.r : piston.r)) : null), 'restrictions')"><span pun ng-click="editRestrictionGroup(collection, (collection.t == 'group' ? ($parent.$parent.parentCollection ? $parent.$parent.parentCollection.r : (statement ? statement.r : piston.r)) : null));">{{collection.rn ? 'not ' : ''}}(</span><span ng-if="view.trace && (mode=='view')" nul> /* #{{collection.$}} */</span></line>
			<container dnd-list="collection.r" dnd-allowed-types="['restriction']">
				<restriction data-ng-repeat-start="restriction in collection.r" ng-init="parentCollection = collection" data-ng-include="'restriction'" dnd-nodrag data-nag-model="collection.r" dnd-draggable="restriction" dnd-nodrag dnd-type="'restriction'" dnd-moved="drag(collection.r, $index);" dnd-effect-allowed="copyMove"></restriction>
				<line operator data-ng-repeat-end ng-click="select(collection, (collection.t == 'group' ? ($parent.$parent.parentCollection ? $parent.$parent.parentCollection.r : (statement ? statement.r : piston.r)) : null), 'restrictions')"><span pun data-ng-click="editRestrictionGroup(collection, (collection.t == 'group' ? ($parent.$parent.parentCollection ? $parent.$parent.parentCollection.r : (statement ? statement.r : piston.r)) : null));">{{collection.rop}}</span></line>
				<line new data-ng-click="addRestriction(collection)">+ add a new restriction</line>
			</container>
			<line data-ng-if-end pun>)</line>
			<restriction ng-if-start="(collection.t != 'group') && !collection.rn" data-ng-repeat-start="restriction in collection.r" data-ng-include="'restriction'" dnd-nodrag data-nag-model="collection.r" dnd-draggable="restriction" dnd-nodrag dnd-type="'restriction'" dnd-moved="drag(collection.r, $index);" dnd-effect-allowed="copyMove"></restriction>
			<line operator ng-if-end data-ng-repeat-end ng-click="select({t: 'group', c: collection.r, o: collection.ro, n: collection.rn}, null, 'restrictions')"><span pun data-ng-click="editRestrictionGroup(collection);">{{collection.rop}}</span></line>
			<line new ng-if="(collection.t != 'group') && !collection.rn" data-ng-click="addRestriction(collection)">+ add a new restriction</line>
		</div>
	</dnd-nodrag>
</script>

<script type="text/ng-template" id="restriction">
	<dnd-nodrag ng-selected="selection == condition">
		<div>
		<trace ng-if="(view.trace && (mode=='view') && trace && trace.points && trace.points['c:' + restriction.$])"><span>+{{trace.points['c:' + restriction.$].o}}ms</span><span dur eval="{{trace.points['c:' + restriction.$].v}}">{{trace.points['c:' + restriction.$].d}}ms</span></trace>
		<subscription ng-if="(mode == 'view') && !!restriction.s" class="fa fa-bolt" title="This restriction subscribes to events"></subscription>
		<restrictions ng-if="restriction.r" data-ng-repeat="collection in [restriction]" data-ng-include="'restrictions'" dnd-nodrag data-nag-model="restriction" dnd-draggable="restriction" dnd-type="'restriction'" dnd-moved="drag(collection.r, $index);" dnd-effect-allowed="copyMove" eval="{{collection && trace && trace.points && trace.points['c:' + collection.$] ? trace.points['c:' + collection.$].v : ''}}"></restrictions>
		<line com ng-if="!restriction.r && !!restriction.z">/* {{restriction.z}} */</line>
		<line cond ng-if="!restriction.r" ng-click="select(restriction, collection.r, 'restriction')">
			<handle dnd-handle><svg class="sprite-icon"><use xlink:href="#drag-handle"></use></svg></handle><span ng-click="editRestriction(restriction, collection.r);" ng-bind-html="restriction.$$html || (restriction.$$html = renderComparison(restriction.lo, restriction.co, restriction.ro, restriction.ro2, restriction.to, restriction.to2))"></span><span ng-if="view.trace && (mode=='view')" nul> /* #{{restriction.$}} */</span>
		</line>
		</div>
	</dnd-nodrag>
</script>





<script type="text/ng-template" id="tasks">
	<task data-ng-repeat="task in tasks" data-ng-include="'task'" dnd-nodrag dnd-draggable="task" dnd-type="'task'" dnd-moved="drag(tasks, $index);" dnd-effect-allowed="copyMove"></task>
	<line new data-ng-click="addTask(statement)">+ add a new task</line>
</script>

<script type="text/ng-template" id="task">
	<dnd-nodrag ng-selected="selection == task">
		<div>
			<trace ng-if="(view.trace && (mode=='view') && trace && trace.points && trace.points['t:' + task.$])"><span>+{{trace.points['t:' + task.$].o}}ms</span><span ng-if="(trace.points['t:' + task.$].v != null) && (trace.points['t:' + task.$].v >= 0)" dur>{{trace.points['t:' + task.$].d}}ms</span><span ng-if="(trace.points['t:' + task.$].v == null) || (trace.points['t:' + task.$].v < 0)" timer ok="{{(trace.points['t:' + task.$].v == null) || (trace.t + trace.points['t:' + task.$].o + trace.points['t:' + task.$].d - trace.points['t:' + task.$].v >= currentTime())}}">{{trace.points['t:' + task.$].v == null ? '▼ ▼ ▼' : timeCounter(trace.t + trace.points['t:' + task.$].o + trace.points['t:' + task.$].d - trace.points['t:' + task.$].v)}}</span></trace>
			<line com ng-if="task.z">/* {{task.z}} */</line>
			<line ng-click="select(task, tasks ? tasks : statement.k, 'task')">
				<handle dnd-handle><svg class="sprite-icon"><use xlink:href="#drag-handle"></use></svg></handle>
				<span kwd data-ng-if="(mode=='edit') && !(((statement.d) && (statement.d.length)) || ((statement.r) && (statement.r.length)) || ((statement.k) && (statement.k.length==0)))" ng-click="editStatement(statement, statements)">do</span>
				<span tsk single="{{(mode != 'edit') && !(((statement.d) && (statement.d.length)) || ((statement.r) && (statement.r.length)) || ((statement.k) && (statement.k.length!=1)))}}" ng-click="editTask(task, statement);" ng-bind-html="task.$$html || (task.$$html = renderTask(task))"></span>
				<span ng-if="view.trace && (mode=='view')" nul> /* #{{task.$}} */</span>
			</line>
		</div>
	</dnd-nodrag>
</script>





<!-- DIALOGS -->



<script type="text/ng-template" id="dialog-edit-statement">
	<designer ng-if="designer.page==0">
		<header>
			<h3>Add a new statement</h3>
		</header>
		<p ng-if="view.advancedStatements">Basic statements</p>
		<div class="form-group">
			<div items class="row">
            	<div item class="col-sm-4" ng-repeat="item in designer.items.simple">
					<item class="alert alert-{{item.cssClass}}">
	                    <div class="title"><span class="fa{{item.iconStyle || 's'}} fa-{{item.icon}}"></span><span help="{{item.name}}"> {{item.name}}</span></div>
	                    <p>{{item.description}}</p>
	                   	<button class="btn btn-{{item.cssClass}}" ng-click="setDesignerType(item.type, true);">Add {{item.button}}</button>
					</item>
                </div>
            </div>
		</div>
		<p ng-if-start="view.advancedStatements">Advanced statements</p>
		<div class="form-group" ng-if-end>
			<div items class="row">
            	<div item class="col-sm-4" ng-repeat="item in designer.items.advanced">
					<item class="alert alert-{{item.cssClass}}">
	                    <div class="title"><span class="fa{{item.iconStyle || 's'}} fa-{{item.icon}}"></span><span help="{{item.name}}"> {{item.name}}</span></div>
	                    <p>{{item.description}}</p>
	                    <button class="btn btn-{{item.cssClass}}" ng-click="setDesignerType(item.type, true);">Add {{item.button}}</button>
					</item>
                </div>
            </div>
		</div>
		<p ng-if-start="designer.clipboard.length">From clipboard</p>
		<div class="form-group" ng-if-end>
			<div ng-repeat="item in designer.clipboard" clipboard-item>
				<statement item data-ng-repeat="statement in [item.o]" data-ng-include="'statement'" type="{{statement.t}}" show-bar="{{(statement.t != 'action') || ((statement.d) && (statement.d.length)) || ((statement.r) && (statement.r.length)) || ((statement.k) && (statement.k.length==0)) ? 'true' : 'false'}}"></statement>
				<div class="footer">
					<button class="btn btn-danger pull-left" ng-click="deleteClipboardItem(item)">Delete from clipboard</button>
                    <button class="btn btn-default" ng-click="pasteItem(item)">Paste this statement</button>
				</div>
            </div>
		</div>
		<footer>
			<button type="button" class="btn btn-default" ng-click="closeDialog();">Cancel</button>
		</footer>
	</designer>

	<designer ng-if="designer.page==1">
		<header>
			<h3 ng-if="designer.$new">Add a new {{designer.type}}</h3>
			<h3 ng-if="!designer.$new">Edit {{designer.type}}</h3>
		</header>
		<form name="form" novalidate>
			<div class="form-group" ng-if="designer.type=='if'">
				<info>An IF block is the simplest decisional block available. It allows you to execute different actions depending on conditions you set.</info>
				<div items class="form-group row">
					<div item class="col-sm-6">
						<item class="alert alert-info">
							<div class="title">Condition</div>
							<p>A condition is a single comparison between two or more operands, the basic building block of a decisional statement</p>
							<div class="text-center"><button class="btn btn-info" ng-click="updateStatement(true, 'condition');">Add a condition</button></div>
						</item>
					</div>
					<div item class="col-sm-6">
						<item class="alert alert-warning">
							<div class="title">Group</div>
							<p>A group is a collection of conditions, with a logical operator between them, allowing for complex decisional statements</p>
							<div class="text-center"><button class="btn btn-warning" ng-click="updateStatement(true, 'group');">Add a group</button></div>
						</item>
					</div>
				</div>
			</div>
			<div class="form-group" ng-if="designer.type=='switch'">
				<info>A SWITCH block is a decisional block designed to compare an expression against a list of possible values and execute actions depending on their matching.</info>
				<label class="col-lg-12 no-padding">Expression<span class="error" ng-if="!designer.operand.valid">{{designer.operand.error}}<span ng-if="designer.operand.expressionVar"> (<a ng-click="autoAddVariable(designer.operand.expressionVar); validateOperand(designer.operand);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
				<operand ng-repeat="operand in [designer.operand]" ng-model="designer.operand" ng-include="'operand'"></operand>
			</div>
			<div class="form-group" ng-if="designer.type=='while'">
				<info>A WHILE loop is an iteration block that checks a condition and executes actions when that condition is true, then repeats the actions until the condition becomes false.</info>
			</div>
			<div class="form-group" ng-if="designer.type=='repeat'">
				<info>A REPEAT loop is an iteration block that executs some actions, then checks a condition and repeats the actions if that condition is found to be true.</info>
			</div>
			<div class="form-group" ng-if="designer.type=='for'">
				<info>A FOR loop is an iteration block that allows you to repeat the same action for a preset number of times, also known as iterations. You can optionally use a counter variable that will be updated to reflect the current iteration index. The system variable <i>$index</i> is also providing that same value. When nesting for loops, $index contains the index for the inner-most loop.</info>
				<div class="form-group">
					<label class="col-lg-12 no-padding">Start value<span class="error" ng-if="!designer.operand.valid">{{designer.operand.error}}<span ng-if="designer.operand.expressionVar"> (<a ng-click="autoAddVariable(designer.operand.expressionVar); validateOperand(designer.operand);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
					<operand ng-repeat="operand in [designer.operand]" ng-model="designer.operand" ng-include="'operand'"></operand>
				</div>
				<div class="form-group">
					<label class="col-lg-12 no-padding">End value<span class="error" ng-if="!designer.operand2.valid">{{designer.operand2.error}}<span ng-if="designer.operand2.expressionVar"> (<a ng-click="autoAddVariable(designer.operand2.expressionVar); validateOperand(designer.operand2);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
					<operand ng-repeat="operand in [designer.operand2]" ng-model="designer.operand2" ng-include="'operand'"></operand>
				</div>
				<div class="form-group">
					<label class="col-lg-12 no-padding">Step<span class="error" ng-if="!designer.operand3.valid">{{designer.operand3.error}}<span ng-if="designer.operand3.expressionVar"> (<a ng-click="autoAddVariable(designer.operand3.expressionVar); validateOperand(designer.operand3);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
					<operand ng-repeat="operand in [designer.operand3]" ng-model="designer.operand3" ng-include="'operand'"></operand>
				</div>
				<div class="form-group">
					<label for="variableInput">Counter variable (optional)</label>
					<div class="form-table">
						<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.x" data-mobile="{{mobile}}" ng-change="">
							<option value="">Nothing selected</option>
							<optgroup ng-if="piston.v && piston.v.length" label="Local variables">
								<option ng-repeat="variable in piston.v" ng-if="['integer', 'decimal', 'dynamic'].indexOf(variable.t) >= 0" value="{{variable.n}}" data-content="<span class='vartype'>{{variable.t}}</span>{{variable.n}}">{{variable.n}} ({{variable.t}})</option>
							</optgroup>
							<optgroup ng-if="globalVars && globalVars.length" label="Global variables">
								<option ng-repeat="variable in globalVars" ng-if="['integer', 'decimal', 'dynamic'].indexOf(variable.t) >= 0" value="{{variable.n}}" data-content="<span class='vartype'>{{variable.t}}</span>{{variable.n}}">{{variable.n}} ({{variable.t}})</option>
							</optgroup>
						</select>
					</div>
				</div>
			</div>
			<div class="form-group" ng-if="designer.type=='each'">
				<info>A FOR EACH loop is an iteration block that allows you to repeat the same action for each device in a device list</info>
				<div class="form-group">
					<label for="variableInput">Counter variable (optional)</label>
					<div class="form-table">
						<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.x" data-mobile="{{mobile}}" ng-change="">
							<option value="">Nothing selected</option>
							<optgroup ng-if="piston.v && piston.v.length" label="Local variables">
								<option ng-repeat="variable in piston.v" ng-if="variable.t == 'device'" value="{{variable.n}}" data-content="<span class='vartype'>{{variable.t}}</span>{{variable.n}}">{{variable.n}} ({{variable.t}})</option>
							</optgroup>
							<optgroup ng-if="globalVars && globalVars.length" label="Global variables">
								<option ng-repeat="variable in globalVars" ng-if="variable.t == 'device'" value="{{variable.n}}" data-content="<span class='vartype'>{{variable.t}}</span>{{variable.n}}">{{variable.n}} ({{variable.t}})</option>
							</optgroup>
						</select>
					</div>
				</div>
				<div class="form-group">
					<label class="col-lg-12 no-padding">List of devices<span class="error" ng-if="!designer.operand.valid">{{designer.operand.error}}<span ng-if="designer.operand.expressionVar"> (<a ng-click="autoAddVariable(designer.operand.expressionVar); validateOperand(designer.operand);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
					<operand ng-repeat="operand in [designer.operand]" ng-model="designer.operand" ng-include="'operand'"></operand>
				</div>
			</div>
			<div class="form-group" ng-if="designer.type=='exit'">
				<info>Return causes the piston to end the evaluation stage and set the piston state to the value provided.</info>
				<label class="col-lg-12 no-padding">New piston state<span class="error" ng-if="!designer.operand.valid">{{designer.operand.error}}<span ng-if="designer.operand.expressionVar"> (<a ng-click="autoAddVariable(designer.operand.expressionVar); validateOperand(designer.operand);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
				<operand ng-repeat="operand in [designer.operand]" ng-model="designer.operand" ng-include="'operand'"></operand>
			</div>
			<div class="form-group" ng-if="designer.type=='do'">
				<info>There are no options for the <i>do</i> statement. Add statements you want to execute.</info>
			</div>
			<div class="form-group" ng-if="designer.type=='on'">
				<info>There are no options for the <i>on</i> statement. Add events that you want to execute statements on.</info>
			</div>
			<div class="form-group" ng-if="designer.type=='action'">
				<info>Actions represent a collection of tasks a device or group of devices have to perform. The <i>Location</i> virtual device provides a way to execute some non-device-specific tasks, such as changing the location mode, the SHM state, sending notifications, communicating with integrated apps, and more. Note that these virtual tasks are also available to any and all devices.</info>
				<div class="form-group">
					<label for="devicesInput">Devices</label>
					<select data-actions-box="true" id="devices" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-info" ng-model="designer.devices"  data-header="Use the input box below to quickly search for devices" data-live-search="true" data-mobile="{{mobile}}" multiple title="Location">
						<optgroup label="Virtual devices">
							<option disabled>Location</option>
						</optgroup>
						<optgroup label="Physical devices">
							<option ng-repeat="device in devices" data-tokens="{{device.tokens}}" value="{{device.id}}">{{device.n}}</option>
						</optgroup>
						<optgroup label="Local variables">
							<option ng-repeat="variable in piston.v" value="{{variable.n}}" ng-if="variable.t == 'device'" data-content="<span class='vartype'>{{variable.t}}</span>{{variable.n}}">{{variable.n}} ({{variable.t}})</option>
						</optgroup>
						<optgroup label="Global variables">
							<option ng-repeat="(name, variable) in globalVars" value="{{name}}" ng-if="variable.t == 'device'" data-content="<span class='vartype'>{{variable.t}}</span>{{name}}">{{name}} ({{variable.t}})</option>
						</optgroup>
						<optgroup label="System variables" ng-if="operand.dataType != 'variable'">
							<option ng-repeat="name in systemVarNames" value="{{name}}" ng-if="systemVars[name].t == 'device'" data-content="<span class='vartype'>{{systemVars[name].t}}</span>{{name}}<span class='varval'>{{systemVars[name].v}}</span>">{{name}} ({{systemVars[name].t}})</option>
						</optgroup>
					</select>
				</div>
			</div>
			<div class="form-group" ng-if="designer.type=='every'">
				<info>Timers trigger piston runs at regular intervals.</info>
				<div class="alert alert-danger" ng-if="(designer.operand.data.vt == 's') && (designer.operand.data.c < 30)">Please note that running timers on such short intervals is very resource intensive and may negatively impact the performance of webCoRE. It is recommended that timers below 30 seconds are avoided, if at all possible.</div>
				<div class="form-group">
					<label for="devicesInput">Every...</label>
					<operand ng-repeat="operand in [designer.operand]" ng-model="designer.operand" ng-include="'operand'"></operand>
				</div>
				<div class="form-group {{form.m.$valid ? '' : 'has-error'}}" ng-if="(designer.operand.data.vt == 'h')">
					<label for="devicesInput">At this minute of the hour...</label>
					<select data-actions-box="true" name="m" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-info" ng-model="designer.operand.data.om" data-mobile="{{mobile}}" required>
						<option value="" style="display:none" disabled>Any</option>
						<option ng-repeat="m in range(60) track by $index" ng-value="$index">{{$index}}</option>
					</select>
				</div>
				<div class="form-group {{form.dow.$valid ? '' : 'has-error'}}" ng-if="designer.operand.data.vt == 'w'">
					<label for="devicesInput">On this day of the week...</label>
					<select data-actions-box="true" name="dow" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-info" ng-model="designer.operand.data.odw" data-mobile="{{mobile}}" required>
						<option value="" style="display:none" disabled>Nothing selected</option>
						<option ng-repeat="day in weekDays track by $index" ng-value="$index">{{day}}</option>
					</select>
				</div>
				<div class="form-group {{form.dom.$valid ? '' : 'has-error'}}" ng-if="(designer.operand.data.vt == 'n') || (designer.operand.data.vt == 'y')">
					<label for="devicesInput">On this day of the month...</label>
					<div class="form-table input-group">
						<select data-actions-box="true" name="dom" selectpicker class="selectpicker show-tick" data-width="50%" data-style="btn-info" ng-model="designer.operand.data.odm" data-mobile="{{mobile}}" ng-options="day.v as day.n for day in listODM()" required>
							<option value="" style="display:none" disabled>Nothing selected</option>
						</select>
						<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="50%" data-style="btn-info" ng-model="designer.operand.data.odw" data-mobile="{{mobile}}" ng-options="day.v as day.n for day in listODW()" ng-required>
							<option value="" style="display:none" disabled>Nothing selected</option>
						</select>
					</div>
				</div>
				<div class="form-group {{form.moy.$valid ? '' : 'has-error'}}" ng-if="(designer.operand.data.vt == 'y')">
					<label for="devicesInput">On this month of the year...</label>
					<select data-actions-box="true" name="moy" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-info" ng-model="designer.operand.data.omy" data-mobile="{{mobile}}" required>
						<option value="" style="display:none" disabled>Nothing selected</option>
						<option ng-repeat="month in yearMonths track by $index" ng-value="$index">{{month}}</option>
					</select>
				</div>
				<div class="form-group" ng-if="(designer.operand.data.vt != 'ms') && (designer.operand.data.vt != 's') && (designer.operand.data.vt != 'm') && (designer.operand.data.vt != 'h')">
					<label for="devicesInput">At this time...</label>
					<operand ng-repeat="operand in [designer.operand2]" ng-model="designer.operand2" ng-include="'operand'"></operand>
				</div>
				<div class="form-group" ng-if="(designer.operand.data.vt != 'ms') && (designer.operand.data.vt != 's') && (designer.operand.data.vt != 'm') && (designer.operand.data.vt != 'h') && (designer.operand2.data.t != 'c')">
					<label for="devicesInput">With this offset...</label>
					<operand ng-repeat="operand in [designer.operand3]" ng-model="designer.operand3" ng-include="'operand'"></operand>
				</div>
				<div class="form-group" ng-if="(designer.operand.data.vt == 'ms') || (designer.operand.data.vt == 's')">
					<label for="devicesInput">Only during these minutes...</label>
					<select data-actions-box="true" name="m" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-warning" ng-model="designer.operand.data.om" data-mobile="{{mobile}}" multiple>
						<option value="" style="display:none" disabled>Any</option>
						<option ng-repeat="m in range(60) track by $index" ng-value="$index">{{$index}}</option>
					</select>
				</div>
				<div class="form-group" ng-if="(designer.operand.data.vt == 'ms') || (designer.operand.data.vt == 's') || (designer.operand.data.vt == 'm')">
					<label for="devicesInput">Only during these hours...</label>
					<select data-actions-box="true" name="h" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-warning" ng-model="designer.operand.data.oh" data-mobile="{{mobile}}" multiple>
						<option value="" style="display:none" disabled>Any</option>
						<option ng-repeat="m in range(24) track by $index" ng-value="$index">{{formatHour($index)}}</option>
					</select>
				</div>
				<div class="form-group" ng-if="(designer.operand.data.vt != 'w') && (designer.operand.data.vt != 'n') && (designer.operand.data.vt != 'y')">
					<label for="devicesInput">Only on these days of the week...</label>
					<select data-actions-box="true" name="dow" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-warning" ng-model="designer.operand.data.odw" data-mobile="{{mobile}}" multiple>
						<option value="" style="display:none" disabled>Any</option>
						<option ng-repeat="day in weekDays track by $index" ng-value="$index">{{day}}</option>
					</select>
				</div>
				<div class="form-group" ng-if="(designer.operand.data.vt != 'n') && (designer.operand.data.vt != 'y') && (!designer.operand.data.owm || !designer.operand.data.owm.length)">
					<label for="devicesInput">Only on these days of the month...</label>
					<select data-actions-box="true" name="dom" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-warning" ng-model="designer.operand.data.odm" data-mobile="{{mobile}}" multiple>
						<option value="" style="display:none" disabled>Any</option>
						<option ng-repeat="d in range(31) track by $index" ng-value="$index + 1">{{getOrdinal($index + 1)}}</option>
						<option ng-value="-1">last</option>
						<option ng-value="-2">second-last</option>
						<option ng-value="-3">third-last</option>
					</select>
				</div>
				<div class="form-group" ng-if="(designer.operand.data.vt != 'n') && (designer.operand.data.vt != 'y') && (!designer.operand.data.odm || !designer.operand.data.odm.length)">
					<label for="devicesInput">Only on these weeks of the month...</label>
					<select data-actions-box="true" name="wom" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-warning" ng-model="designer.operand.data.owm" data-mobile="{{mobile}}" multiple>
						<option value="" style="display:none" disabled>Any</option>
						<option ng-repeat="d in range(5) track by $index" ng-value="$index + 1">{{getOrdinal($index + 1)}}</option>
						<option ng-value="-1">last</option>
						<option ng-value="-2">second-last</option>
						<option ng-value="-3">third-last</option>
					</select>
				</div>
				<div class="form-group" ng-if="(designer.operand.data.vt != 'y')">
					<label for="devicesInput">Only on these months of the year...</label>
					<select data-actions-box="true" name="moy" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-warning" ng-model="designer.operand.data.omy" data-mobile="{{mobile}}" multiple>
						<option value="" style="display:none" disabled>Any</option>
						<option ng-value="1">January</option>
						<option ng-value="2">February</option>
						<option ng-value="3">March</option>
						<option ng-value="4">April</option>
						<option ng-value="5">May</option>
						<option ng-value="6">June</option>
						<option ng-value="7">July</option>
						<option ng-value="8">August</option>
						<option ng-value="9">September</option>
						<option ng-value="10">October</option>
						<option ng-value="11">November</option>
						<option ng-value="12">December</option>
					</select>
				</div>
			</div>
			<div ng-if="designer.showAdvancedOptions" class="form-group">
				<div class="form-group">
					<label for="descriptionInput">Description (optional)</label>
					<textarea name="desc" type="text" id="descriptionInput" class="form-control" placeholder="Description for this statement" ng-model="designer.description" msd-elastic></textarea>
				</div>
				<div class="form-group" ng-if="designer.type != 'on'">
					<label for="tep" help>Task Execution Policy</label>
					<select data-actions-box="true" name="tep" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.tep" data-mobile="{{mobile}}">
						<option value="">Always execute tasks (default)</option>
						<option value="c">Execute tasks on condition state change only</option>
						<option value="p">Execute tasks on piston state change only</option>
						<option value="b">Execute tasks on condition or piston state change only</option>
					</select>
				</div>
				<div class="form-group" ng-if="designer.type != 'on'">
					<label for="tcp" help>Task Cancellation Policy</label>
					<select data-actions-box="true" name="tcp" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.tcp" data-mobile="{{mobile}}">
						<option value="">Never cancel tasks</option>
						<option value="c">Cancel tasks on condition state change (default)</option>
						<option value="p">Cancel tasks on piston state change</option>
						<option value="b">Cancel tasks on condition or piston state change</option>
					</select>
				</div>
				<div class="form-group" ng-if="designer.type == 'action'">
					<label for="tsp" help>Task Scheduling Policy</label>
					<select data-actions-box="true" name="tsp" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.tsp" data-mobile="{{mobile}}">
						<option value="">Override any existing scheduled tasks (default)</option>
						<option value="a">Allow multiple scheduled tasks</option>
					</select>
				</div>
<!--				<div class="form-group" ng-if="(designer.type=='action' ) && (designer.tcp !='none')">
					<label for="tcp">Task Cancellation Policy Restriction</label>
					<select data-actions-box="true" name="tcpr" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.tcpr" data-mobile="{{mobile}}">
						<option value="none">None</option>
						<option value="to">Only when state changes to a specified value</option>
						<option value="from">Only when state changes away from a specified value</option>
					</select>
				</div>
				<div class="form-group" ng-if="(designer.type=='action' ) && (designer.tcp !='none' ) && (designer.tcpr !='none')">
					<label for="tcp">Task Cancellation Policy Restriction Value</label>
					<input name="tcprv" class="form-control" type="text" ng-model="designer.tcpv" />
				</div>	-->
				<div class="form-group" ng-if="designer.type=='switch'">
					<label for="break" help>Case Traversal Policy</label>
					<select data-actions-box="true" name="ctp" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.ctp" data-mobile="{{mobile}}">
						<option value="i">Safe (auto-break after matching a case) (default)</option>
						<option value="e">Fall-through (programmer style)</option>
					</select>
				</div>
				<div class="form-group" ng-if="(designer.type != 'every') && (designer.type != 'on')">
					<label for="async" help>Execution Method</label>
					<select data-actions-box="true" name="async" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.async" data-mobile="{{mobile}}">
						<option value="0">Synchronous (default)</option>
						<option value="1">Asynchronous</option>
					</select>
				</div>
				<div class="form-group">
					<label help>Disable statement</label>
					<select data-actions-box="true" name="disabled" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.disabled" data-mobile="{{mobile}}">
						<option value="0">No (default)</option>
						<option value="1">Yes</option>
					</select>
				</div>
			</div>
		</form>
		<footer>
			<!--<button type="button" ng-if="(designer.type=='if' ) && (designer.$new)" class="btn btn-info pull-right" ng-disabled="!designer.type" ng-click="updateStatement(true);">Add a condition</button>-->
			<button type="button" ng-if="(designer.type=='do' ) && (designer.$new)" class="btn btn-info pull-right" ng-disabled="!designer.type" ng-click="updateStatement(true);">Add a statement</button>
			<button type="button" ng-if="(designer.type=='on' ) && (designer.$new)" class="btn btn-info pull-right" ng-disabled="!designer.type" ng-click="updateStatement(true);">Add an event</button>
			<button type="button" ng-if="(designer.type=='switch' ) && (designer.$new)" class="btn btn-info pull-right" ng-disabled="!designer.type" ng-click="updateStatement(true);">Add a case</button>
			<button type="button" ng-if="(designer.type=='for' ) && (designer.$new)" class="btn btn-info pull-right" ng-disabled="!designer.type" ng-click="updateStatement(true);">Add a statement</button>
			<button type="button" ng-if="(designer.type=='each' ) && (designer.$new)" class="btn btn-info pull-right" ng-disabled="!designer.type" ng-click="updateStatement(true);">Add a statement</button>
			<button type="button" ng-if="(designer.type=='while' ) && (designer.$new)" class="btn btn-info pull-right" ng-disabled="!designer.type" ng-click="updateStatement(true);">Add a condition</button>
			<button type="button" ng-if="(designer.type=='repeat' ) && (designer.$new)" class="btn btn-info pull-right" ng-disabled="!designer.type" ng-click="updateStatement(true);">Add a statement</button>
			<button type="button" ng-if="(designer.type=='every' ) && (designer.$new)" class="btn btn-info pull-right" ng-disabled="!designer.type" ng-click="updateStatement(true);">Add a statement</button>
			<button type="button" ng-if="(designer.type=='action' ) && (designer.$new)" class="btn btn-info pull-right" ng-disabled="!designer.type" ng-click="updateStatement(true);">Add a task</button>
			<button type="button" ng-if="(designer.type=='break' ) && (designer.$new)" class="btn btn-info pull-right" ng-disabled="!designer.type || form.$invalid" ng-click="updateStatement();">Add</button>
			<button type="button" ng-if="(designer.type=='exit' ) && (designer.$new)" class="btn btn-info pull-right" ng-disabled="!designer.type || form.$invalid" ng-click="updateStatement();">Add</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-info pull-right" ng-disabled="!designer.type || form.$invalid" ng-click="updateStatement();">Save</button>
			<button type="button" ng-if="!designer.$new && ((designer.type=='if' ) || (designer.type=='while' ) || (designer.type=='repeat' ))" class="btn btn-warning pull-right" ng-disabled="!designer.type" ng-click="upgradeStatement();">Convert to new group</button>
			<button type="button" class="btn btn-default pull-right" ng-click="toggleAdvancedOptions();" title="Show/Hide advanced options"><i class="fa fa-cog"></i></button>
			<button type="button" ng-if="designer.$new" class="btn btn-default" ng-click="prevPage();">Back</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-default" ng-click="closeDialog();">Cancel</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-danger" ng-click="deleteObject();">Delete</button>
		</footer>
	</designer>
</script>

<script type="text/ng-template" id="dialog-edit-event">
	<designer>
		<header>
			<h3>{{designer.$new ? 'Add' : 'Edit' }} an event</h3>
		</header>
		<form>
			<info ng-if="designer.type=='condition'">An event allows the execution of statements when certain devices' attributes change.</info>
			<comparison ng-repeat="comparison in [designer.comparison]" ng-include="'comparison'"></comparison>

			<div ng-if="designer.showAdvancedOptions" class="form-group">
				<div class="form-group">
					<label for="descriptionInput">Description (optional)</label>
					<textarea type="text" id="descriptionInput" class="form-control" placeholder="Description for this event" ng-model="designer.description" msd-elastic></textarea>
				</div>
			</div>

		</form>
		<footer>
			<button type="button" ng-if="designer.$new" class="btn btn-info pull-right" ng-disabled="!designer.comparison.left.valid" ng-click="updateEvent();">Add</button>
			<button type="button" ng-if="designer.$new" class="btn btn-success pull-right" ng-disabled="!designer.comparison.left.valid" ng-click="updateEvent(true);">Add more</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-info pull-right" ng-disabled="!designer.comparison.left.valid" ng-click="updateEvent();">Save</button>
			<button type="button" class="btn btn-default pull-right" ng-click="toggleAdvancedOptions();" title="Show/Hide advanced options"><i class="fa fa-cog"></i></button>
			<button type="button" class="btn btn-default" ng-click="closeDialog();">Cancel</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-danger" ng-click="deleteObject();">Delete</button>
		</footer>
	</designer>
</script>



<script type="text/ng-template" id="dialog-edit-condition">
	<designer ng-if="designer.page==0">
		<header>
			<h3>Add a new condition</h3>
		</header>
		<form>
			<div class="form-group">
				<info>An IF block is the simplest decisional block available. It allows you to execute different actions depending on conditions you set.</info>
				<div items class="form-group row">
					<div item class="col-sm-6">
						<item class="alert alert-info">
							<div class="title">Condition</div>
							<p>A condition is a single comparison between two or more operands, the basic building block of a decisional statement</p>
							<div class="text-center"><button class="btn btn-info" ng-click="setDesignerType('condition', true);">Add a condition</button></div>
						</item>
					</div>
					<div item class="col-sm-6">
						<item class="alert alert-warning">
							<div class="title">Group</div>
							<p>A group is a collection of conditions, with a logical operator between them, allowing for complex decisional statements</p>
							<div class="text-center"><button class="btn btn-warning" ng-click="setDesignerType('group', true);">Add a group</button></div>
						</item>
					</div>
				</div>
			</div>
			<p ng-if-start="designer.clipboard.length">From clipboard</p>
			<div class="form-group" ng-if-end>
				<div ng-repeat="item in designer.clipboard" clipboard-item>
					<condition item data-ng-repeat="condition in [item.o]" data-ng-include="'condition'" type="{{item.o.t}}"></condition>
					<div class="footer">
						<button class="btn btn-danger pull-left" ng-click="deleteClipboardItem(item)">Delete from clipboard</button>
	                    <button class="btn btn-default" ng-click="pasteItem(item)">Paste this condition</button>
					</div>
	            </div>
			</div>
		</form>
		<footer>
			<button type="button" class="btn btn-default" ng-click="closeDialog();">Cancel</button>
		</footer>
	</designer>

	<designer ng-if="designer.page==1">
		<header>
			<h3 ng-if="designer.$new">Add a new {{designer.type}}</h3>
			<h3 ng-if="!designer.$new">Edit {{designer.type}}</h3>
		</header>
		<form>
			<info ng-if="designer.type=='condition'">A condition allows for a single comparison to be made between two expressions.</info>
			<info ng-if="designer.type=='group'">A group is a container for other conditions or groups and allows building more complex logic.</info>
			<comparison ng-if="designer.type=='condition'" ng-repeat="comparison in [designer.comparison]" ng-include="'comparison'"></comparison>
			<div class="form-group" ng-if-start="designer.type=='group'">
				<label for="operator">Logical Operator</label>
					<div class="form-table input-group">
					<select data-actions-box="true" id="operator" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.operator" data-mobile="{{mobile}}">
						<option value="and">Logical AND</option>
						<option value="or">Logical OR</option>
						<option value="xor">Logical eXclusive OR (XOR)</option>
						<option value="followed by">Followed by</option>
					</select>
				</div>
			</div>
			<div class="form-group">
				<label for="operator">Whole group negation</label>
				<div class="form-table input-group">
					<select data-actions-box="true" id="operator" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.not" data-mobile="{{mobile}}">
						<option value="0">Not negated</option>
						<option value="1">Negated</option>
					</select>
				</div>
			</div>
			<div class="form-group" ng-if="designer.followedBy">
				<label class="col-lg-12 no-padding">Within...<span class="error" ng-if="!designer.comparison.within.valid">{{designer.comparison.within.error}}<span ng-if="designer.comparison.within.expressionVar"> (<a ng-click="autoAddVariable(designer.comparison.within.expressionVar); validateOperand(designer.comparison.left);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
				<operand ng-repeat="operand in [designer.comparison.within]" ng-model="designer.comparison.within" ng-include="'operand'"></operand>
			</div>
			<div class="form-group" ng-if="designer.followedBy" ng-if-end>
				<label class="col-lg-12 no-padding">Matching method</label>
				<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-success" ng-model="designer.comparison.withinOpt" data-mobile="{{mobile}}">
					<option value="l">Loose (any unexpected event is ignored)</option>
					<option value="s">Strict (any unexpected event resets the group)</option>
					<option value="n">Negated (lack of the expected event resets the group)</option>
				</select>
			</div>

			<div ng-if="designer.showAdvancedOptions" class="form-group">
				<div class="form-group" ng-if="(designer.type=='condition') && (designer.comparison.left.data.t == 'p')">
					<label>Store the list of matching devices into variable...</label>
					<div class="form-table">
						<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.comparison.left.data.dm" data-mobile="{{mobile}}" ng-change="">
							<option value="">Nothing selected</option>
							<optgroup ng-if="piston.v && piston.v.length" label="Local variables">
								<option ng-repeat="variable in piston.v" ng-if="variable.t == 'device'" value="{{variable.n}}" data-content="<span class='vartype'>{{variable.t}}</span>{{variable.n}}">{{variable.n}} ({{variable.t}})</option>
							</optgroup>
							<optgroup ng-if="globalVars && globalVars.length" label="Global variables">
								<option ng-repeat="variable in globalVars" ng-if="variable.t == 'device'" value="{{variable.n}}" data-content="<span class='vartype'>{{variable.t}}</span>{{variable.n}}">{{variable.n}} ({{variable.t}})</option>
							</optgroup>
						</select>
					</div>
				</div>
				<div class="form-group" ng-if="(designer.type=='condition') && (designer.comparison.left.data.t == 'p')">
					<label>Store the list of non-matching devices into variable...</label>
					<div class="form-table">
						<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.comparison.left.data.dn" data-mobile="{{mobile}}" ng-change="">
							<option value="">Nothing selected</option>
							<optgroup ng-if="piston.v && piston.v.length" label="Local variables">
								<option ng-repeat="variable in piston.v" ng-if="variable.t == 'device'" value="{{variable.n}}" data-content="<span class='vartype'>{{variable.t}}</span>{{variable.n}}">{{variable.n}} ({{variable.t}})</option>
							</optgroup>
							<optgroup ng-if="globalVars && globalVars.length" label="Global variables">
								<option ng-repeat="variable in globalVars" ng-if="variable.t == 'device'" value="{{variable.n}}" data-content="<span class='vartype'>{{variable.t}}</span>{{variable.n}}">{{variable.n}} ({{variable.t}})</option>
							</optgroup>
						</select>
					</div>
				</div>
				<div class="form-group">
					<label for="smode">Subscription method</label>
					<select data-actions-box="true" id="smode" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.smode" data-mobile="{{mobile}}">
						<option value="auto">Automatic</option>
						<option value="always">Always subscribe</option>
						<option value="never">Never subscribe</option>
					</select>
				</div>
				<div class="form-group">
					<label for="descriptionInput">Description (optional)</label>
					<textarea type="text" id="descriptionInput" class="form-control" placeholder="Description for this statement" ng-model="designer.description" msd-elastic></textarea>
				</div>
			</div>

		</form>
		<footer>
			<button type="button" ng-if="designer.$new" class="btn btn-info pull-right" ng-disabled="!designer.type || ((designer.type=='condition') && !designer.comparison.valid)" ng-click="updateCondition();">Add</button>
			<button type="button" ng-if="designer.$new" class="btn btn-success pull-right" ng-disabled="!designer.type || ((designer.type=='condition') && !designer.comparison.valid)" ng-click="updateCondition(true);">Add more</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-info pull-right" ng-disabled="!designer.type || ((designer.type=='condition') && !designer.comparison.valid)" ng-click="updateCondition();">Save</button>
			<!--<button type="button" ng-if="!designer.$new && designer.parent" class="btn btn-info pull-right" ng-disabled="!designer.type" ng-click="upgradeCondition();">Convert to new group</button>-->
			<button type="button" class="btn btn-default pull-right" ng-click="toggleAdvancedOptions();" title="Show/Hide advanced options"><i class="fa fa-cog"></i></button>
			<button type="button" ng-if="designer.$new" class="btn btn-default" ng-click="prevPage();">Back</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-default" ng-click="closeDialog();">Cancel</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-danger" ng-click="deleteObject();">Delete</button>
		</footer>
	</designer>
</script>


<script type="text/ng-template" id="dialog-edit-condition-group">
	<designer>
		<header>
			<h3>Edit condition group</h3>
		</header>
		<form>
			<div class="form-group">
				<label for="operator">Logical Operator</label>
				<div class="form-table input-group">
					<select data-actions-box="true" id="operator" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.operator" data-mobile="{{mobile}}">
						<option value="and">Logical AND</option>
						<option value="or">Logical OR</option>
						<option value="xor">Logical eXclusive OR (XOR)</option>
						<option value="followed by">Followed by</option>
					</select>
				</div>
			</div>
			<div class="form-group">
				<label for="operator">Whole group negation</label>
				<div class="form-table input-group">
					<select data-actions-box="true" id="operator" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.not" data-mobile="{{mobile}}">
						<option value="0">Not negated</option>
						<option value="1">Negated</option>
					</select>
				</div>
			</div>

			<div ng-if="designer.showAdvancedOptions" class="form-group">
				<div class="form-group">
					<label for="descriptionInput">Description (optional)</label>
					<textarea type="text" id="descriptionInput" class="form-control" placeholder="Description for this statement" ng-model="designer.description" msd-elastic></textarea>
				</div>
			</div>


			<div class="form-group" ng-if="designer.followedBy">
				<label class="col-lg-12 no-padding">Within...<span class="error" ng-if="!designer.within.valid">{{designer.within.error}}<span ng-if="designer.within.expressionVar"> (<a ng-click="autoAddVariable(designer.within.expressionVar); validateOperand(designer.within);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
				<operand ng-repeat="operand in [designer.within]" ng-model="designer.within" ng-include="'operand'"></operand>
			</div>
			<div class="form-group" ng-if="designer.followedBy">
				<label class="col-lg-12 no-padding">Matching method</label>
				<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-success" ng-model="designer.withinOpt" data-mobile="{{mobile}}">
					<option value="l">Loose (any unexpected event is ignored)</option>
					<option value="s">Strict (any unexpected event resets the group)</option>
					<option value="n">Negated (lack of the expected event resets the group)</option>
				</select>
			</div>
		</form>
		<footer>
			<button type="button" class="btn btn-info pull-right" ng-click="updateConditionGroup();">Save</button>
			<button type="button" class="btn btn-default pull-right" ng-click="toggleAdvancedOptions();" title="Show/Hide advanced options"><i class="fa fa-cog"></i></button>
			<button type="button" class="btn btn-default" ng-click="closeDialog();">Cancel</button>
			<button type="button" ng-if="designer.parent" class="btn btn-danger" ng-click="deleteObject();">Delete</button>
		</footer>
	</designer>
</script>






<script type="text/ng-template" id="dialog-edit-restriction">
	<designer ng-if="designer.page==0">
		<header>
			<h3>Add a new restriction</h3>
		</header>
		<form>
			<div class="form-group">
				<info>An IF block is the simplest decisional block available. It allows you to execute different actions depending on conditions you set.</info>
				<div class="alert alert-danger">Restrictions are conditions that need to be met for the execution to continue. Restrictions <b>DO NOT</b> subscribe to events and will not cause the piston to run.</div>
				<div items class="row">
					<div item class="col-sm-6">
						<item>
							<div class="alert alert-info"><span class="far fa-question-circle"></span><span> Restriction</span></div>
							<p>A restriction is a single comparison between two or more operands, the basic building block of a decisional statement</p>
							<div class="text-center"><button class="btn btn-info" ng-click="setDesignerType('restriction', true);">Add a restriction</button></div>
						</item>
					</div>
					<div item class="col-sm-6">
						<item>
							<div class="alert alert-warning"><span class="fa fa-object-group"></span><span> Group</span></div>
							<p>A group is a collection of restrictions, with a logical operator between them, allowing for complex decisional statements</p>
							<div class="text-center"><button class="btn btn-warning" ng-click="setDesignerType('group', true);">Add a group</button></div>
						</item>
					</div>
				</div>
			</div>
			<p ng-if-start="designer.clipboard.length">From clipboard</p>
			<div class="form-group" ng-if-end>
				<div ng-repeat="item in designer.clipboard" clipboard-item>
					<restriction item data-ng-repeat="restriction in [item.o]" data-ng-include="'restriction'" type="{{item.o.t}}"></restriction>
					<div class="footer">
						<button class="btn btn-danger pull-left" ng-click="deleteClipboardItem(item)">Delete from clipboard</button>
	                    <button class="btn btn-default" ng-click="pasteItem(item)">Paste this restriction</button>
					</div>
	            </div>
			</div>
		</form>
		<footer>
			<button type="button" class="btn btn-default" ng-click="closeDialog();">Cancel</button>
		</footer>
	</designer>
	<designer ng-if="designer.page==1">
		<header>
			<h3 ng-if="designer.$new">Add a new {{designer.type}}</h3>
			<h3 ng-if="!designer.$new">Edit {{designer.type}}</h3>
		</header>
		<form>
			<info ng-if="designer.type=='restriction'">A restriction allows for a single comparison to be made between two expressions.</info>
			<info ng-if="designer.type=='group'">A group is a container for other restrictions or groups and allows building more complex logic.</info>
			<div class="alert alert-danger">Restrictions are conditions that need to be met for the execution to continue. Restrictions <b>DO NOT</b> subscribe to events and will not cause the piston to run.</div>
			<comparison ng-if="designer.type=='restriction'" ng-repeat="comparison in [designer.comparison]" ng-include="'comparison'"></comparison>
			<div class="form-group" ng-if-start="designer.type=='group'">
				<label for="operator">Logical Operator</label>
				<div class="form-table input-group">
					<select data-actions-box="true" id="operator" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.operator" data-mobile="{{mobile}}">
						<option value="and">Logical AND</option>
						<option value="or">Logical OR</option>
						<option value="xor">Logical eXclusive OR (XOR)</option>
						<option value="followed by">Followed by</option>
					</select>
				</div>
			</div>
			<div class="form-group" ng-if-end>
				<label for="operator">Whole group negation</label>
				<div class="form-table input-group">
					<select data-actions-box="true" id="operator" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.not" data-mobile="{{mobile}}">
						<option value="0">Not negated</option>
						<option value="1">Negated</option>
					</select>
				</div>
			</div>

			<div ng-if="designer.showAdvancedOptions" class="form-group">
				<label for="descriptionInput">Description (optional)</label>
				<textarea type="text" id="descriptionInput" class="form-control" placeholder="Description for this statement" ng-model="designer.description" msd-elastic></textarea>
			</div>
		</form>
		<footer>
			<button type="button" ng-if="designer.$new" class="btn btn-info pull-right" ng-disabled="!designer.type || ((designer.type=='restriction') && !designer.comparison.valid)" ng-click="updateRestriction();">Add</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-info pull-right" ng-disabled="!designer.type || ((designer.type=='restriction') && !designer.comparison.valid)" ng-click="updateRestriction();">Save</button>
			<button type="button" ng-if="(0==1) && !designer.$new && designer.parent" class="btn btn-info pull-right" ng-disabled="!designer.type" ng-click="upgradeRestriction();">Convert to new group</button>
			<button type="button" class="btn btn-default pull-right" ng-click="toggleAdvancedOptions();" title="Show/Hide advanced options"><i class="fa fa-cog"></i></button>
			<button type="button" ng-if="designer.$new" class="btn btn-default" ng-click="prevPage();">Back</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-default" ng-click="closeDialog();">Cancel</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-danger" ng-click="deleteObject();">Delete</button>
		</footer>
	</designer>
</script>



<script type="text/ng-template" id="dialog-edit-restriction-group">
	<designer>
		<header>
			<h3>Edit restriction group</h3>
		</header>
		<form>
			<div class="form-group">
				<label for="operator">Logical Operator</label>
				<div class="form-table input-group">
					<select data-actions-box="true" id="operator" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.operator" data-mobile="{{mobile}}">
						<option value="and">Logical AND</option>
						<option value="or">Logical OR</option>
						<option value="xor">Logical eXclusive OR (XOR)</option>
						<option value="followed by">Followed by</option>
					</select>
				</div>
			</div>
			<div class="form-group">
				<label for="operator">Whole group negation</label>
				<div class="form-table input-group">
					<select data-actions-box="true" id="operator" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.not" data-mobile="{{mobile}}">
						<option value="0">Not negated</option>
						<option value="1">Negated</option>
					</select>
				</div>
			</div>

			<div ng-if="designer.showAdvancedOptions" class="form-group">
				<div class="form-group">
					<label for="descriptionInput">Description (optional)</label>
					<textarea type="text" id="descriptionInput" class="form-control" placeholder="Description for this statement" ng-model="designer.description" msd-elastic></textarea>
				</div>
			</div>
		</form>
		<footer>
			<button type="button" class="btn btn-info pull-right" ng-click="updateRestrictionGroup();">Save</button>
			<button type="button" class="btn btn-default pull-right" ng-click="toggleAdvancedOptions();" title="Show/Hide advanced options"><i class="fa fa-cog"></i></button>
			<button type="button" class="btn btn-default" ng-click="closeDialog();">Cancel</button>
			<button type="button" ng-if="designer.parent" class="btn btn-danger" ng-click="deleteObject();">Delete</button>
		</footer>
	</designer>
</script>


<script type="text/ng-template" id="dialog-edit-case">
	<designer>
		<header>
			<h3 ng-if="designer.$new">Add a new case</h3>
			<h3 ng-if="!designer.$new">Edit case</h3>
		</header>
		<form>
			<div class="form-group">
				<info>A CASE block allows statements execution if the switch expression matches its value.</info>
				<label>Case type</label>
				<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-default" ng-model="designer.type" data-mobile="{{mobile}}" ng-change="">
					<option value="s">Single value</option>
					<option value="r">Range</option>
					<option value="" style="display:none" disabled>Nothing selected</option>
				</select>
			</div>
			<div class="form-group">
				<label>Switch expresssion {{designer.type == 'r' ? 'is between' : 'matches'}}</label>
				<operand ng-repeat="operand in [designer.operand]" ng-model="designer.operand" ng-include="'operand'"></operand>
				<label ng-if-start="designer.type == 'r'">and</label>
				<operand ng-if-end ng-repeat="operand in [designer.operand2]" ng-model="designer.operand" ng-include="'operand'"></operand>
			</div>
			<div ng-if="designer.showAdvancedOptions" class="form-group">
				<label for="descriptionInput">Description (optional)</label>
				<textarea type="text" id="descriptionInput" class="form-control" placeholder="Description for this statement" ng-model="designer.description" msd-elastic></textarea>
			</div>
		</form>
		<footer>
			<button type="button" ng-if="designer.$new" class="btn btn-info pull-right" ng-disabled="!designer.type" ng-click="updateCase(true);">Add a statement</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-info pull-right" ng-disabled="!designer.type" ng-click="updateCase();">Save</button>
			<button type="button" class="btn btn-default pull-right" ng-click="toggleAdvancedOptions();" title="Show/Hide advanced options"><i class="fa fa-cog"></i></button>
			<button type="button" class="btn btn-default" ng-click="closeDialog();">Cancel</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-danger" ng-click="deleteObject();">Delete</button>
		</footer>
	</designer>
</script>


<script type="text/ng-template" id="comparison">
	<div class="form-group">
		<label class="col-lg-12 no-padding">{{comparison.event ? 'What event to expect' : 'What to compare'}}<span class="error" ng-if="!designer.comparison.left.valid">{{designer.comparison.left.error}}<span ng-if="designer.comparison.left.expressionVar"> (<a ng-click="autoAddVariable(designer.comparison.left.expressionVar); validateOperand(designer.comparison.left);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
		<operand ng-repeat="operand in [designer.comparison.left]" ng-model="designer.comparison.left" ng-include="'operand'"></operand>
	</div>
	<div ng-if="!comparison.event" class="form-group {{comparison.operatorValid ? '' : 'has-error'}}">
		<label class="col-lg-12 no-padding">What kind of comparison?</label>
		<select data-actions-box="true" id="operator" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-info" ng-model="comparison.operator" data-mobile="{{mobile}}" ng-change="validateComparison(comparison)" ng-options="option.id as option.d group by option.c for option in comparison.options">
			<option style="display:none" value="" disabled>Select a comparison...</option>
		</select>
	</div>
	<div ng-if="comparison.dataType == 'email'">
		<div class="form-group">
			<label class="col-lg-12 no-padding">From<span class="error" ng-if="!designer.comparison.right.valid">{{designer.comparison.right.error}}<span ng-if="designer.comparison.right.expressionVar"> (<a ng-click="autoAddVariable(designer.comparison.right.expressionVar); validatecomparison.right(designer.comparison.right);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
			<operand ng-repeat="operand in [designer.comparison.right]" ng-model="designer.comparison.left" ng-include="'operand'"></operand>
		</div>
		<div class="form-group">
			<label class="col-lg-12 no-padding">Message<span class="error" ng-if="!designer.comparison.right2.valid">{{designer.comparison.right2.error}}<span ng-if="designer.comparison.right2.expressionVar"> (<a ng-click="autoAddVariable(designer.comparison.right2.expressionVar); validatecomparison.right2(designer.comparison.right2);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
			<operand ng-repeat="operand in [designer.comparison.right2]" ng-model="designer.comparison.right2" ng-include="'operand'"></operand>
		</div>
	</div>
	<div ng-if="comparison.dataType != 'email'">
	<div class="form-group" ng-if="!comparison.event && (comparison.parameterCount > 0)">
		<label class="col-lg-12 no-padding">{{comparison.parameterCount == 1 ? 'Compare to' : 'Between...'}}<span class="error" ng-if="!designer.comparison.right.valid">{{designer.comparison.right.error}}<span ng-if="designer.comparison.right.expressionVar"> (<a ng-click="autoAddVariable(designer.comparison.right.expressionVar); validatecomparison.right(designer.comparison.right);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
		<operand ng-repeat="operand in [designer.comparison.right]" ng-model="designer.comparison.right" ng-include="'operand'"></operand>
	</div>
	<div class="form-group" ng-if="!comparison.event && (comparison.parameterCount > 0) && (designer.comparison.left.selectedDataType=='time') && (designer.comparison.right.data.t != 'c')">
		<label class="col-lg-12 no-padding">With offset...<span class="error" ng-if="!designer.comparison.right.valid">{{designer.comparison.time.error}}<span ng-if="designer.comparison.time.expressionVar"> (<a ng-click="autoAddVariable(designer.comparison.time.expressionVar); validatecomparison.right(designer.comparison.time);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
		<operand ng-repeat="operand in [designer.comparison.time]" ng-model="deisgner.comparison.time" ng-include="'operand'"></operand>
	</div>
	<div class="form-group" ng-if="!comparison.event && (comparison.parameterCount > 1)">
		<label class="col-lg-12 no-padding">...and...<span class="error" ng-if="!designer.comparison.right2.valid">{{designer.comparison.right2.error}}<span ng-if="designer.comparison.right2.expressionVar"> (<a ng-click="autoAddVariable(designer.comparison.right2.expressionVar); validatecomparison.right2(designer.comparison.right2);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
		<operand ng-repeat="operand in [designer.comparison.right2]" ng-model="designer.comparison.right2" ng-include="'operand'"></operand>
	</div>
	<div class="form-group" ng-if="!comparison.event && (comparison.parameterCount > 1) && (designer.comparison.left.selectedDataType=='time') && (designer.comparison.right2.data.t != 'c')">
		<label class="col-lg-12 no-padding">With offset...<span class="error" ng-if="!designer.comparison.right.valid">{{designer.comparison.time2.error}}<span ng-if="designer.comparison.time2.expressionVar"> (<a ng-click="autoAddVariable(designer.comparison.time2.expressionVar); validatecomparison.right(designer.comparison.time2);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
		<operand ng-repeat="operand in [designer.comparison.time2]" ng-model="deisgner.comparison.time2" ng-include="'operand'"></operand>
	</div>
	<div class="form-group" ng-if="!comparison.event && comparison.timed">
		<label class="col-lg-12 no-padding">{{comparison.timed == 1 ? 'In the last...' : 'For...'}}<span class="error" ng-if="!designer.comparison.time.valid">{{designer.comparison.time.error}}<span ng-if="designer.comparison.time.expressionVar"> (<a ng-click="autoAddVariable(designer.comparison.time.expressionVar); validatecomparison.time(designer.comparison.time);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
		<div class="form-group" ng-if="comparison.timed == 2">
			<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-warning" ng-model="comparison.time.data.f" data-mobile="{{mobile}}" ng-change="validateComparison(comparison)">
				<option style="display:none" value="" disabled>Select an option...</option>
				<option value="l">less than...</option>
				<option value="g">at least...</option>
			</select>
		</div>
		<operand ng-repeat="operand in [designer.comparison.time]" ng-model="designer.comparison.time" ng-include="'operand'"></operand>
	</div>
	<div class="form-group" ng-if="!comparison.event && (comparison.left.data.t == 'v') && (comparison.left.data.v == 'ifttt')">
		<label class="col-lg-12 no-padding">Use this URL in your IFTTT's Maker channel</label>
		<textarea class="form-control" ifttt readonly value="test" msd-elastic>{{getIFTTTUri(comparison.right.data.c)}}</textarea>
	</div>
	<div class="form-group" ng-if="!comparison.event && (designer.comparison.left.data.t == 'v') && (designer.comparison.left.data.v == 'time')">
		<label for="devicesInput">Only on these days of the week...</label>
		<select data-actions-box="true" name="dow" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-warning" ng-model="designer.comparison.left.data.odw" data-mobile="{{mobile}}" multiple>
			<option value="" style="display:none" disabled>Any</option>
			<option ng-repeat="day in weekDays track by $index" ng-value="$index">{{day}}</option>
		</select>
	</div>
	<div class="form-group" ng-if="!comparison.event && ((designer.comparison.left.data.t == 'v') && (designer.comparison.left.data.v == 'time')) && (!designer.comparison.left.data.owm || !designer.comparison.left.data.owm.length)">
		<label for="devicesInput">Only on these days of the month...</label>
		<select data-actions-box="true" name="dom" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-warning" ng-model="designer.comparison.left.data.odm" data-mobile="{{mobile}}" multiple>
			<option value="" style="display:none" disabled>Any</option>
			<option ng-repeat="d in range(31) track by $index" ng-value="$index + 1">{{getOrdinal($index + 1)}}</option>
			<option ng-value="-1">last</option>
			<option ng-value="-2">second-last</option>
			<option ng-value="-3">third-last</option>
		</select>
	</div>
	<div class="form-group" ng-if="!comparison.event && ((designer.comparison.left.data.t == 'v') && (designer.comparison.left.data.v == 'time')) && (!designer.comparison.left.data.odm || !designer.comparison.left.data.odm.length)">
		<label for="devicesInput">Only on these weeks of the month...</label>
		<select data-actions-box="true" name="wom" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-warning" ng-model="designer.comparison.left.data.owm" data-mobile="{{mobile}}" multiple>
			<option value="" style="display:none" disabled>Any</option>
			<option ng-repeat="d in range(5) track by $index" ng-value="$index + 1">{{getOrdinal($index + 1)}}</option>
			<option ng-value="-1">last</option>
			<option ng-value="-2">second-last</option>
			<option ng-value="-3">third-last</option>
		</select>
	</div>
	<div class="form-group" ng-if="!comparison.event && (designer.comparison.left.data.t == 'v') && (designer.comparison.left.data.v == 'time')">
		<label for="devicesInput">Only on these months of the year...</label>
		<select data-actions-box="true" name="moy" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-warning" ng-model="designer.comparison.left.data.omy" data-mobile="{{mobile}}" multiple>
			<option value="" style="display:none" disabled>Any</option>
			<option ng-value="1">January</option>
			<option ng-value="2">February</option>
			<option ng-value="3">March</option>
			<option ng-value="4">April</option>
			<option ng-value="5">May</option>
			<option ng-value="6">June</option>
			<option ng-value="7">July</option>
			<option ng-value="8">August</option>
			<option ng-value="9">September</option>
			<option ng-value="10">October</option>
			<option ng-value="11">November</option>
			<option ng-value="12">December</option>
		</select>
	</div>

	<div class="form-group" ng-if="designer.followedBy">
		<label class="col-lg-12 no-padding">Within...<span class="error" ng-if="!designer.comparison.within.valid">{{designer.comparison.within.error}}<span ng-if="designer.comparison.within.expressionVar"> (<a ng-click="autoAddVariable(designer.comparison.within.expressionVar); validateOperand(designer.comparison.left);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
		<operand ng-repeat="operand in [designer.comparison.within]" ng-model="designer.comparison.within" ng-include="'operand'"></operand>
	</div>
	<div class="form-group" ng-if="designer.followedBy">
		<label class="col-lg-12 no-padding">Matching method</label>
		<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-success" ng-model="designer.comparison.withinOpt" data-mobile="{{mobile}}">
			<option value="l">Loose (any unexpected event is ignored)</option>
			<option value="s">Strict (any unexpected event resets the group)</option>
			<option value="n">Negated (lack of the expected event resets the group)</option>
		</select>
	</div>
	</div>
</script>


<script type="text/ng-template" id="operand">
	<div class="form-group" nag-init="validateOperand(operand);">
<!--
		<label class="col-lg-12 no-padding"><span class="error" ng-if="!operand.valid">{{operand.error}}<span ng-if="operand.expressionVar"> (<a ng-click="autoAddVariable(operand.expressionVar); validateOperand(operand);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
-->
		<div class="form-group" ng-if="(!operand.event) && (operand.data.t=='p') && (operand.data.d) && ((operand.data.d.length> 1) || ((operand.data.d.length == 1) && !operand.data.d[0].startsWith(':'))) && (!operand.disableAggregation)">
			<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-warning" ng-model="operand.data.g" data-mobile="{{mobile}}" ng-change="validateOperand(operand)">
				<optgroup label="No aggregation">
					<option value="any">Any of the selected devices</option>
					<option value="all" ng-if="operand.allowAll">All of the selected devices</option>
				</optgroup>
				<optgroup label="Mathematical aggregation" ng-if="operand.allowAggregation">
					<option value="avg">Average</option>
					<option value="count">Count</option>
					<option value="least">Least occurring value</option>
					<option value="max">Maximum</option>
					<option value="median">Median</option>
					<option value="min">Minimum</option>
					<option value="most">Most occurring value</option>
					<option value="stdev">Standard deviation</option>
					<option value="sum">Sum</option>
					<option value="variance">Variance</option>
				</optgroup>
				<option style="display:none" value="" disabled>Nothing selected</option>
			</select>
		</div>
		<div class="form-table input-group {{operand.valid ? '' : 'has-error'}}">
			<select data-actions-box="true" selectpicker class="selectpicker show-tick input-addon" data-width="25%" data-style="btn-{{operand.style ? operand.style : 'info'}}" ng-model="operand.data.t" data-mobile="{{mobile}}" ng-change="validateOperand(operand)">
				<option ng-if="operand.optional" value="">Nothing selected</option>
				<option ng-if="!operand.optional" style="display:none" disabled value="">Nothing selected</option>
				<option ng-if="operand.allowDevices" value="d">Physical device(s)</option>
				<option ng-if="operand.allowPhysical" value="p">Physical device(s)</option>
				<option ng-if="operand.allowVirtual" value="v" ng-if="designer.type != 'for'">Virtual device</option>
				<option ng-if="operand.allowPreset" value="s">Preset</option>
				<option ng-if="operand.allowConstant" value="c">Value</option>
				<option ng-if="operand.allowVariable" value="x">Variable</option>
				<option ng-if="operand.allowExpression" value="e">Expression</option>
				<option ng-if="operand.allowArgument" value="u">Argument</option>
			</select>
			<div class="form-table input-group">
				<div class="form-table input-group" ng-if="operand.data.t==''">
					<label class="form-control btn-info">(no value set)</label>
				</div>
				<!-- physical devices (variable) -->
				<div class="form-table input-group" ng-if="operand.data.t=='d'">
					<select data-actions-box="true" selectpicker class="selectpicker show-tick no-border-radius" data-show-subtext="false" data-width="100%" data-style="btn-default" ng-model="operand.data.d"  data-header="Use the input box below to quickly search for devices" data-live-search="true" data-mobile="{{mobile}}" multiple ng-change="validateOperand(operand)" required>
						<optgroup label="Physical devices">
							<option ng-repeat="device in devices" data-tokens="{{device.tokens}}" value="{{device.id}}">{{device.n}}</option>
						</optgroup>
						<optgroup label="Local variables">
							<option ng-repeat="variable in piston.v" value="{{variable.n}}" ng-if="variable.t == 'device'" data-content="<span class='vartype'>{{variable.t}}</span>{{variable.n}}">{{variable.n}} ({{variable.t}})</option>
						</optgroup>
						<optgroup label="Global variables">
							<option ng-repeat="(name, variable) in globalVars" value="{{name}}" ng-if="variable.t == 'device'" data-content="<span class='vartype'>{{variable.t}}</span>{{name}}">{{name}} ({{variable.t}})</option>
						</optgroup>
						<optgroup label="System variables" ng-if="operand.dataType != 'variable'">
							<option ng-repeat="name in systemVarNames" value="{{name}}" ng-if="systemVars[name].t == 'device'" data-content="<span class='vartype'>{{systemVars[name].t}}</span>{{name}}<span class='varval'>{{systemVars[name].v}}</span>">{{name}} ({{systemVars[name].t}})</option>
						</optgroup>
					</select>
				</div>
				<!-- physical devices -->
				<div class="form-table input-group" ng-if="operand.data.t=='p'">
					<select data-actions-box="true" selectpicker class="selectpicker show-tick no-border-radius" data-show-subtext="false" data-width="75%" data-style="btn-default" ng-model="operand.data.d"  data-header="Use the input box below to quickly search for devices" data-live-search="true" data-mobile="{{mobile}}" multiple ng-change="validateOperand(operand)">
						<optgroup label="Physical devices">
							<option ng-repeat="device in devices" data-tokens="{{device.tokens}}" ng-if="!operand.restrictAttribute || hasAttribute(device, operand.restrictAttribute)" value="{{device.id}}">{{device.n}}</option>
						</optgroup>
						<optgroup label="Local variables">
							<option ng-repeat="variable in piston.v" value="{{variable.n}}" ng-if="variable.t == 'device'" data-content="<span class='vartype'>{{variable.t}}</span>{{variable.n}}">{{variable.n}} ({{variable.t}})</option>
						</optgroup>
						<optgroup label="Global variables">
							<option ng-repeat="(name, variable) in globalVars" value="{{name}}" ng-if="variable.t == 'device'" data-content="<span class='vartype'>{{variable.t}}</span>{{name}}">{{name}} ({{variable.t}})</option>
						</optgroup>
						<optgroup label="System variables" ng-if="operand.dataType != 'variable'">
							<option ng-repeat="name in systemVarNames" value="{{name}}" ng-if="systemVars[name].t == 'device'" data-content="<span class='vartype'>{{systemVars[name].t}}</span>{{name}}<span class='varval'>{{systemVars[name].v}}</span>">{{name}} ({{systemVars[name].t}})</option>
						</optgroup>
					</select>
					<select data-actions-box="true" attr selectpicker class="selectpicker show-tick input-addon" data-width="25%" data-style="btn-default" ng-model="operand.data.a" data-mobile="{{mobile}}" ng-change="validateOperand(operand)" ng-options="attribute.id as attribute.n for attribute in operand.attributes">
						<option style="display:none" value="">Nothing selected</option>
					</select>
				</div>
				<!-- virtual devices -->
				<div class="form-table input-group" ng-if="operand.data.t=='v'">
					<select data-actions-box="true" selectpicker class="selectpicker show-tick no-border-radius" data-width="100%" data-style="btn-default" ng-model="operand.data.v" data-mobile="{{mobile}}"  ng-change="validateOperand(operand)" required>
						<option style="display:none" value="" disabled>Nothing selected</option>
						<option ng-repeat="device in virtualDevices" ng-if="(designer.type == 'condition') || (designer.type == 'restriction') || !!device.x" value="{{device.id}}">{{device.n}}</option>
					</select>
				</div>
				<!-- variables -->
				<div class="form-table input-group pull-left" ng-if="(operand.data.t=='x') && (!operand.multiple)" style="width:{{(operand.dataType == 'duration' ? 75 : 100) - (getLocalVariableType(operand.data.x).endsWith(']') ? 25 : 0)}}%">
					<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="75%" data-style="btn-default" ng-model="operand.data.x" data-mobile="{{mobile}}" ng-change="validateOperand(operand)" required>
						<option style="display:none" value="" disabled>Nothing selected</option>
						<optgroup ng-if="!operand.event && piston.v && piston.v.length" label="Local variables">
							<option ng-repeat="variable in piston.v" value="{{variable.n}}" ng-if="!operand.restrictType || (operand.restrictType.indexOf(variable.t) >= 0)" data-content="<span class='vartype'>{{variable.t}}</span>{{variable.n}}">{{variable.n}} ({{variable.t}})</option>
						</optgroup>
						<optgroup label="Global variables">
							<option ng-repeat="(name, variable) in globalVars" value="{{name}}" ng-if="!operand.restrictType || (operand.restrictType.indexOf(variable.t) >= 0)" data-content="<span class='vartype'>{{variable.t}}</span>{{name}}">{{name}} ({{variable.t}})</option>
						</optgroup>
						<optgroup label="System variables" ng-if="!operand.event && operand.dataType != 'variable'">
							<option ng-repeat="name in systemVarNames" value="{{name}}" ng-if="!operand.restrictType || (operand.restrictType.indexOf(systemVars[name].t) >= 0)" data-content="<span class='vartype'>{{systemVars[name].t}}</span>{{name}}<span class='varval'>{{systemVars[name].v}}</span>">{{name}} ({{systemVars[name].t}})</option>
						</optgroup>
					</select>
				</div>
				<!-- constant -->
				<div class="form-table input-group pull-left" ng-if="(operand.data.t=='x') && (!operand.multiple) && getLocalVariableType(operand.data.x).endsWith(']')" style="width:25%">
					<input class="form-control" ng-model="operand.data.xi" type="text" ng-change="validateOperand(operand)" placeholder="list index" required/>
				</div>
				<div class="form-table input-group pull-left" ng-if="(operand.data.t=='x') && (!!operand.multiple)" style="width:{{operand.dataType == 'duration' ? '75' : '100'}}%">
					<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="75%" data-style="btn-default" ng-model="operand.data.x" data-mobile="{{mobile}}" ng-change="validateOperand(operand)" multiple required>
						<option style="display:none" value="" disabled>Nothing selected</option>
						<optgroup ng-if="piston.v && piston.v.length" label="Local variables">
							<option ng-repeat="variable in piston.v" value="{{variable.n}}" ng-if="(!operand.restrictType || (operand.restrictType.indexOf(variable.t) >= 0)) && !variable.t.endsWith(']')" data-content="<span class='vartype'>{{variable.t}}</span>{{variable.n}}">{{variable.n}} ({{variable.t}})</option>
						</optgroup>
						<optgroup label="Global variables">
							<option ng-repeat="(name, variable) in globalVars" value="{{name}}" ng-if="!operand.restrictType || (operand.restrictType.indexOf(variable.t) >= 0)" data-content="<span class='vartype'>{{variable.t}}</span>{{name}}">{{name}} ({{variable.t}})</option>
						</optgroup>
						<optgroup label="System variables">
							<option ng-repeat="name in systemVarNames" value="{{name}}" ng-if="!operand.restrictType || (operand.restrictType.indexOf(systemVars[name].t) >= 0)" data-content="<span class='vartype'>{{systemVars[name].t}}</span>{{name}}<span class='varval'>{{systemVars[name].v}}</span>">{{name}} ({{systemVars[name].t}})</option>
						</optgroup>
					</select>
				</div>
				<!-- preset -->
				<div class="form-table input-group pull-left" ng-if="(operand.data.t=='s') && ((operand.dataType == 'time') || (operand.dataType == 'datetime'))" style="width:100%">
					<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="75%" data-style="btn-default" ng-model="operand.data.s" data-mobile="{{mobile}}" ng-change="validateOperand(operand)" required>
						<option style="display:none" value="" disabled>Nothing selected</option>
						<option value="sunrise">Sunrise</option>
						<option value="noon">Noon</option>
						<option value="sunset">Sunset</option>
						<option value="midnight">Midnight</option>
					</select>
				</div>
				<div class="form-table input-group pull-left" ng-if="(operand.data.t=='s') && (operand.dataType == 'color')" style="width:100%">
					<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="75%" data-style="btn-default" ng-model="operand.data.s" data-mobile="{{mobile}}" ng-change="validateOperand(operand)" required>
						<option style="display:none" value="" disabled>Nothing selected</option>
						<option value="Random" data-content="<span class='color' style='background: #fff'>?</span>Random">Random</option>
						<option value="Black" data-content="<span class='color' style='background: #000'></span>Black">Black</option>
						<option ng-repeat="color in db.colors.standard" ng-value="color.name" data-content="<span class='color' style='background: {{color.rgb}}'></span>{{color.name}}">{{color.name}}</option>
					</select>
				</div>
				<!-- argument -->
				<div class="form-table input-group pull-left" ng-if="(operand.data.t=='u')" style="width:{{operand.dataType == 'duration' ? '75' : '100'}}%">
					<input class="form-control" ng-model="operand.data.u" type="text" ng-change="validateOperand(operand)" required/>
				</div>
				<!-- constant -->
				<div class="form-table input-group pull-left" ng-if="(operand.data.t=='c') && (!operand.options.length) && (operand.dataType != 'lifxSelector')" style="width:{{operand.dataType == 'duration' ? '75' : '100'}}%">
					<input ng-if="['time', 'date', 'datetime'].indexOf(operand.inputType) < 0" class="form-control" ng-model="operand.data.c" type="{{operand.inputType}}" ng-change="validateOperand(operand)" ng-min="(operand.dataType == 'duration') && (operand.requirePositiveNumber) ? 1 : null" required/>
					<input ng-if="operand.inputType == 'time'" class="form-control" ng-model="operand.data.c" ng-model-options="{ updateOn: 'blur', '*': '$inherit' }" type="time" ng-change="validateOperand(operand)" ng-min="(operand.dataType == 'duration') && (operand.requirePositiveNumber) ? 1 : null" required/>
					<input ng-if="operand.inputType == 'date'" class="form-control" ng-model="operand.data.c" ng-model-options="{ updateOn: 'blur', '*': '$inherit' }" type="date" ng-change="validateOperand(operand)" ng-min="(operand.dataType == 'duration') && (operand.requirePositiveNumber) ? 1 : null" required/>
					<input ng-if="operand.inputType == 'datetime'" class="form-control" ng-model="operand.data.c" ng-model-options="{ updateOn: 'blur', '*': '$inherit' }" type="datetime-local" ng-change="validateOperand(operand)" ng-min="(operand.dataType == 'duration') && (operand.requirePositiveNumber) ? 1 : null" required/>
				</div>
				<div class="form-table input-group pull-left" ng-if="(operand.data.t=='c') && (operand.options.length) && (!operand.multiple) && (operand.dataType != 'lifxSelector')" style="width:{{operand.dataType == 'duration' ? '75' : '100'}}%">
					<select data-actions-box="true" selectpicker class="selectpicker show-tick no-border-radius" data-width="75%" data-style="btn-default" ng-model="operand.data.c" data-mobile="{{mobile}}" ng-change="validateOperand(operand)">
						<option style="display:none" value="" disabled>Nothing selected</option>
						<option ng-repeat="option in operand.options" value="{{option.n ? option.v : option}}">{{option.n ? option.n : option}}</option>
					</select>
				</div>
				<div class="form-table input-group pull-left" ng-if="(operand.data.t=='c') && (operand.options.length) && (!!operand.multiple) && (operand.dataType != 'lifxSelector')" style="width:{{operand.dataType == 'duration' ? '75' : '100'}}%">
					<select data-actions-box="true" selectpicker class="selectpicker show-tick no-border-radius" data-width="75%" data-style="btn-default" ng-model="operand.data.c" data-mobile="{{mobile}}" ng-change="validateOperand(operand)" multiple required>
						<option style="display:none" value="" disabled>Nothing selected</option>
						<option ng-repeat="option in operand.options" value="{{option.n ? option.v : option}}">{{option.n ? option.n : option}}</option>
					</select>
				</div>
				<div class="form-table input-group pull-left" ng-if="(operand.data.t=='c') && (operand.dataType == 'lifxSelector')" style="width:{{operand.dataType == 'duration' ? '75' : '100'}}%">
					<select data-actions-box="true" selectpicker class="selectpicker show-tick no-border-radius" data-width="75%" data-style="btn-default" ng-model="operand.data.c" data-mobile="{{mobile}}" ng-change="validateOperand(operand)">
						<option style="display:none" value="" disabled>Nothing selected</option>
						<optgroup label="All lights">
							<option value="all">All lights</option>
						</optgroup>
						<optgroup label="Individual lights" ng-if="lifx.lights.length">
							<option ng-repeat="option in lifx.lights" value="{{option.v}}">{{option.n ? option.n : option}}</option>
						</optgroup>
						<optgroup label="Groups" ng-if="lifx.groups.length">
							<option ng-repeat="option in lifx.groups" value="{{option.v}}">{{option.n ? option.n : option}}</option>
						</optgroup>
						<optgroup label="Locations" ng-if="lifx.locations.length">
							<option ng-repeat="option in lifx.locations" value="{{option.v}}">{{option.n ? option.n : option}}</option>
						</optgroup>
						<optgroup label="Scenes" ng-if="lifx.scenes.length">
							<option ng-repeat="option in lifx.scenes" value="{{option.v}}">{{option.n ? option.n : option}}</option>
						</optgroup>
					</select>
				</div>
				<div class="form-table input-group pull-left" ng-if="operand.data.t=='e'" style="display: inline-block; width:{{operand.dataType == 'duration' ? '75' : '100'}}%">
					<!-- expression -->
					<label allow-animations class="form-control btn-default ellipsis" title="{{operand.data.e}}" ng-bind-html="operand.expressionError ? operand.expressionError : operand.eval"></label>
				</div>
				<!-- last - duration unit -->
				<div class="form-table input-group pull-left" ng-if="(operand.data.t != '') && (operand.dataType == 'duration')" style="width:25%">
					<select data-actions-box="true" selectpicker class="show-tick selectpicker input-group-btn" data-width="100%" ng-model="operand.durationUnit" data-mobile="{{mobile}}" data-style="btn-default" ng-change="validateOperand(operand)" required>
						<option style="display:none" value="" disabled>Nothing selected</option>
						<option value="ms" ng-if="!operand.hideMilliseconds">milliseconds</option>
						<option value="s">seconds</option>
						<option value="m">minutes</option>
						<option value="h">hours</option>
						<option value="d">days</option>
						<option value="w">weeks</option>
						<option value="n">months</option>
						<option value="y">years</option>
					</select>
				</div>
			</div>
		</div>
		<div ng-if="operand.data.t=='e'" class="form-group">
			<textarea expression smart-area="operand.config" rows="3" class="form-control" id="leftItem" ng-model="operand.data.e" ng-change="validateOperand(operand)" spellcheck="false" ng-trim="true" msd-elastic></textarea>
		</div>
	</div>
	<div class="form-group" ng-if="(operand.data.t=='p') && operand.count && operand.showSubDevices">
		<div class="form-table input-group">
			<label class="form-control btn-info">Which {{operand.subDeviceName ? operand.subDeviceName : operand.data.a}}(s)</label>
			<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-style="btn-default" data-width="75%" ng-model="operand.data.i" data-mobile="{{mobile}}" ng-change="validateOperand(operand)" multiple title="Any">
				<option style="display:none" disabled>Any</option>
				<option ng-if="operand.data.a == 'lock'" value="0">#0</option>
				<option ng-repeat="a in range(operand.count) track by $index" value="{{$index + 1}}">#{{$index + 1}}</option>
			</select>
		</div>
	</div>
	<div class="form-group" ng-if="(operand.data.t=='p') && operand.interactive && operand.showInteraction">
		<div class="form-table input-group">
			<label class="form-control btn-info">Which interaction</label>
			<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-style="btn-default" data-width="75%" ng-model="operand.data.p" data-mobile="{{mobile}}" ng-change="validateOperand(operand)">
				<option style="display:none" value="" disabled>Nothing selected</option>
				<option value="a">Any interaction</option>
				<option value="p">Physical interaction</option>
				<option value="s">Programmatic interaction</option>
			</select>
		</div>
	</div>
</script>




<script type="text/ng-template" id="parameter">
	<!--<div>Rendering parameter {{$parent.parameter}}</div>-->
	<div class="form-group" ng-if="parameter.i=='color'">
		<label for="param{{$index}}">{{parameter.n}} {{parameter.t}} {{parameter.i}}&nbsp;{{parameter.v}}{{parameter.u ? parameter.u : ''}}</label>
		<select data-actions-box="true" ng-if="parameter.i=='color'" nag-init="initBootstrapSelect()" selectpicker class="show-tick selectpicker" data-width="100%" ng-model="parameter.v" data-mobile="{{mobile}}" data-style="btn-default">
			<optgroup label="Special colors">
				<option value="random">Random color</option>
				<option value="custom">Custom color</option>
			</optgroup>
			<optgroup label="Whites">
			</optgroup>
			<optgroup label="Standard colors">
				<option ng-repeat="color in colors" value="{{color.rgb}}">{{color.n}}</option>
			</optgroup>
		</select>
		<a-ckolor ng-if="(parameter.i=='color') && (parameter.v=='custom')" model="parameter.customValue" class="btn form-control btn-default" blur="false" name="colorPicker" default-color="'#ffcc99'"></a-ckolor>
	</div>
	<div class="form-group">
	</div>
	<div class="form-group" ng-if="parameter.i=='text'">
		<label class="control-label" for="param{{$index}}">{{parameter.n}}</label>
		<input type="text" id="param{{$index}}" class="form-control" ng-model="parameter.v">
	</div>
	<div class="form-group" ng-if="parameter.i=='range'">
		<label class="control-label" for="param{{$index}}">{{parameter.n}}</label>
		<label class="pull-right">{{parameter.v}}{{parameter.u}}</label>
		<input type="range" min="{{parameter.m}}" max="{{parameter.M}}" id="param{{$index}}" class="form-control-static" ng-model="parameter.v">
	</div>
	<div class="form-group has-feedback has-feedback-right" ng-if="parameter.i=='number'">
		<label class="control-label" for="param{{$index}}">{{parameter.n}}</label>
		<input type="number" min="{{parameter.m}}" max="{{parameter.M}}" id="param{{$index}}" class="form-control" ng-model="parameter.v">
		<span class="form-control-feedback">{{parameter.u}}</span>
	</div>
	<div class="form-group" ng-if="(parameter.i=='boolean')">
		<label class="control-label" for="param{{$index}}">{{parameter.n}}</label>
		<select data-actions-box="true" nag-init="initBootstrapSelect()" selectpicker class="show-tick selectpicker" data-width="100%" ng-model="parameter.v" data-mobile="{{mobile}}" data-style="btn-default">
			<option value="" ng-if="parameter.d">Nothing selected</option>
			<option value="false">false</option>
			<option value="true">true</option>
		</select>
	</div>
	<div class="form-group" ng-if="(parameter.i=='enum') && (!parameter.d)">
		<label class="control-label" for="param{{$index}}">{{parameter.n}}</label>
		<select data-actions-box="true" ng-if="parameter.o && (parameter.o.length > 6)" nag-init="initBootstrapSelect()" selectpicker class="show-tick selectpicker" data-width="100%" ng-model="parameter.v" data-mobile="{{mobile}}" data-style="btn-default">
			<option ng-repeat="option in parameter.o" value="{{option}}">{{option}}</option>
		</select>
		<div class="btn-group btn-group-justified" ng-if="parameter.o && (parameter.o.length <= 6)">
  			<label ng-repeat="option in parameter.o" class="form-control btn btn-default{{option == $parent.parameter.v ? ' active btn-info' : ''}}">{{option}}<input type="radio" ng-model="$parent.parameter.v" ng-value="option" name="param{{$parent.$index}}" /></label>
		</div>
	</div>
	<div class="form-group" ng-if="(parameter.i=='enum') && (!!parameter.d)">
		<label class="control-label" for="param{{$index}}">{{parameter.n}}</label>
		<select data-actions-box="true" ng-if="parameter.o && (parameter.o.length > 6)" nag-init="initBootstrapSelect()" selectpicker class="show-tick selectpicker" data-width="100%" ng-model="parameter.v" data-mobile="{{mobile}}" data-style="btn-default">
			<option value="">Nothing selected</option>
			<option ng-repeat="option in parameter.o" value="{{option}}">{{option}}</option>
		</select>
		<div class="btn-group btn-group-justified" ng-if="parameter.o && (parameter.o.length <= 6)">
  			<label ng-repeat="option in parameter.o" class="form-control btn btn-default{{option == $parent.parameter.v ? ' active btn-info' : ''}}">{{option}}<input type="radio" ng-model="$parent.parameter.v" ng-value="!!$parent.parameter.d && (option == $parent.parameter.v) ? null : option" name="param{{$parent.$index}}" /></label>
		</div>
	</div>
	<div class="form-group" ng-if="(parameter.i=='duration') && (!parameter.d)">
		<label class="control-label" for="param{{$index}}">{{parameter.n}}</label>
		<div class="form-table input-group">
			<input type="number" min="0" class="form-control" ng-model="parameter.v"/>
			<select data-actions-box="true" selectpicker class="show-tick selectpicker input-group-btn" data-width="25%" ng-model="parameter.vt" data-mobile="{{mobile}}" data-style="btn-default">
				<option value="ms">milliseconds</option>
				<option value="s">seconds</option>
				<option value="m">minutes</option>
				<option value="h">hours</option>
				<option value="d">days</option>
				<option value="w">weeks</option>
				<option value="n">months</option>
				<option value="y">years</option>
				<option style="display:none" value="" disabled>Nothing selected</option>
			</select>
		</div>
	</div>
	<div class="alert alert-warn" ng-if="parameter.warn">{{parameter.warn}}</div>
</script>


<script type="text/ng-template" id="dialog-edit-task">
	<designer ng-if="designer.page==0">
		<header>
			<h3>Add a new task</h3>
		</header>
		<form>
			<div class="form-group">
				<label for="devicesInput">With...</label>
				<p ng-bind-html="renderDeviceNameList(designer.parent.d)"></p>
			</div>
			<div class="form-group" ng-if="designer.parent.k.length">
				<task preview ng-repeat="task in designer.parent.k" ng-click="selectTaskIndex($index);" ng-if="($index < designer.insertIndex) && (task != designer.$task)">
					<span pun>Do </span><span tsk ng-bind-html="task.$$html || (task.$$html = renderTask(task))"></span>
				</task>
			</div>
			<div taskedit>
				<div class="form-group" nag-init="prepareParameters();">
					<label for="devicesInput">Do...</label>
					<select data-actions-box="true" id="command" selectpicker class="show-tick" data-width="100%" ng-model="designer.command" data-live-search="true" data-mobile="{{mobile}}" data-style="btn-info" ng-change="prepareParameters();">
						<option value=''>Please select a command</option>
						<optgroup label="Commands available to all devices" ng-if="designer.commands.common">
							<option ng-repeat="command in designer.commands.common" value="{{command.id}}" data-content="<span class='vartype'>{{command.em ? 'emulated' : (command.cm ? 'custom' : 'device')}}</span>{{command.n}}">{{command.n}}</option>
						</optgroup>
						<optgroup label="Location commands (non-device)">
							<option ng-repeat="command in designer.commands.virtual" value="{{command.id}}" data-content="<span class='vartype'>location</span>{{command.n}}">{{command.n}}</option>
						</optgroup>
						<optgroup label="Commands available to only some devices" ng-if="designer.commands.partial">
							<option ng-repeat="command in designer.commands.partial" value="{{command.id}}" data-content="<span class='vartype'>{{command.em ? 'emulated' : (command.cm ? 'custom' : 'device')}}</span>{{command.n}}">{{command.n}}</option>
						</optgroup>
					</select>
				</div>
				<div ng-repeat="operand in designer.parameters" ng-hide="operand.hidden">
					<label class="col-lg-12 no-padding">{{operand.name}}{{operand.optional ? ' (optional)' : ''}}<span class="error" ng-if="!operand.valid">{{operand.error}}<span ng-if="operand.expressionVar"> (<a ng-click="autoAddVariable(operand.expressionVar); validateOperand(operand);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
					<div class="alert alert-warning" ng-if="operand.warn">{{operand.warn}}</div>
					<parameter ng-include="'operand'" ng-model="operand"></parameter>
				</div>
				<label ng-if-start="!!designer.command"class="col-lg-12 no-padding">Only during these modes</label>
				<div ng-if-end class="form-group">
					<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-warning" ng-model="designer.mode" data-mobile="{{mobile}}" multiple>
						<option style="display:none" value="" disabled>Any</option>
						<option ng-repeat="mode in location.modes" value="{{mode.id}}">{{mode.name}}</option>
					</select>
				</div>
			</div>
			<div class="form-group" ng-if="designer.parent.k.length">
				<task preview ng-repeat="task in designer.parent.k" ng-click="selectTaskIndex($index + 1);" ng-if="($index >= designer.insertIndex) && (task != designer.$task)">
					<span pun>Do </span><span tsk ng-bind-html="task.$$html || (task.$$html = renderTask(task))"></span>
				</task>
			</div>
			<div ng-if="designer.showAdvancedOptions" class="form-group">
				<label for="descriptionInput">Description (optional)</label>
				<textarea type="text" id="descriptionInput" class="form-control" placeholder="Description for this statement" ng-model="designer.description" msd-elastic></textarea>
			</div>
			<p ng-if-start="designer.clipboard.length">From clipboard</p>
			<div class="form-group" ng-if-end>
				<div ng-repeat="item in designer.clipboard" clipboard-item>
					<task item data-ng-repeat="task in [item.o]" data-ng-include="'task'"></task>
					<div class="footer">
						<button class="btn btn-danger pull-left" ng-click="deleteClipboardItem(item)">Delete from clipboard</button>
	                    <button class="btn btn-default" ng-click="pasteItem(item)">Paste this task</button>
					</div>
	            </div>
			</div>
		</form>

		<footer>
			<button type="button" ng-if="designer.$new" class="btn btn-info pull-right" ng-disabled="!designer.command" ng-click="updateTask();">Add</button>
			<button type="button" ng-if="designer.$new" class="btn btn-success pull-right" ng-disabled="!designer.command" ng-click="updateTask(true);">Add more</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-info pull-right" ng-disabled="!designer.command" ng-click="updateTask();">Save</button>
			<button type="button" class="btn btn-default pull-right" ng-click="toggleAdvancedOptions();" title="Show/Hide advanced options"><i class="fa fa-cog"></i></button>
			<button type="button" class="btn btn-default" ng-click="closeDialog();">Cancel</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-danger" ng-click="deleteObject();">Delete</button>
			<div ng-if="designer.custom" class="btn-group">
				<button class="btn btn-secondary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
				Parameters <span class="caret"></span>
				</button>
				<div class="dropdown-menu" aria-labelledby="dropdownMenuButton">
					<li><a href="#" ng-click="addParameter('string')">Add a string parameter</a></li>
					<li><a href="#" ng-click="addParameter('integer')">Add an integer parameter</a></li>
					<li><a href="#" ng-click="addParameter('decimal')">Add a decimal parameter</a></li>
					<li><a href="#" ng-click="addParameter('boolean')">Add a boolean parameter</a></li>
					<li><a href="#" ng-click="addParameter('datetime')">Add a datetime parameter</a></li>
					<li ng-if="designer.parameters.length" role="separator" class="divider"></li>
					<li ng-repeat="parameter in designer.parameters" ng-click="deleteParameter(parameter);"><a href="#">Delete Parameter {{$index + 1}}</a></li>
				</div>
			</div>
		</footer>
	</designer>

</script>





<script type="text/ng-template" id="dialog-edit-variable">
	<designer ng-if="designer.page==0">
		<header>
			<h3>{{designer.$new ? 'Add a new' : 'Edit'}} variable</h3>
		</header>
		<form>
			<div class="form-group">
				<div class="form-table input-group">
					<select data-actions-box="true" id="type" selectpicker class="selectpicker show-tick input-addon" data-width="25%" data-style="btn-info" ng-model="designer.operand.dataType" data-mobile="{{mobile}}" ng-change="validateOperand(designer.operand, true); refreshSelects()">
						<optgroup label="Basic">
							<option value="dynamic">Dynamic</option>
							<option value="string">String (text)</option>
							<option value="boolean">Boolean (true/false)</option>
							<option value="integer">Number (integer)</option>
							<option value="decimal">Number (decimal)</option>
							<option value="long">Large number (long)</option>
							<option value="datetime">Date and Time</option>
							<option value="date">Date (date only)</option>
							<option value="time">Time (time only)</option>
							<option value="device">Device</option>
						</optgroup>
						<optgroup label="Advanced lists">
							<option value="dynamic[]">Dynamic list</option>
							<option value="string[]">String list (text)</option>
							<option value="boolean[]">Boolean list (true/false)</option>
							<option value="integer[]">Number list (integer)</option>
							<option value="decimal[]">Number list (decimal)</option>
							<option value="long[]">Large number list (long)</option>
							<option value="datetime[]">Date and Time list</option>
							<option value="date[]">Date list (date only)</option>
							<option value="time[]">Time list (time only)</option>
						</optgroup>
					</select>
					<input class="form-control" id="name" ng-model="designer.name" type="text" />
				</div>
			</div>
			<div class="form-group" ng-if="designer.operand.dataType && !designer.operand.dataType.endsWith(']')">
				<label class="col-lg-12 no-padding">Initial value (optional)<span class="error" ng-if="!designer.operand.valid">{{designer.operand.error}}<span ng-if="designer.operand.expressionVar"> (<a ng-click="autoAddVariable(designer.operand.expressionVar); validateOperand(designer.operand);">create it</a>)</span>&nbsp;<i class="fas fa-exclamation-triangle"></i></span></label>
				<operand ng-repeat="operand in [designer.operand]" ng-model="designer.operand" ng-include="'operand'"></operand>
			</div>
			<div class="form-group" ng-if="(designer.operand.data.t != '') && designer.operand.dataType && !designer.operand.dataType.endsWith(']')">
				<label>NOTE: By assigning an initial value to the variable, you are instructing the piston to initialize the variable on every run to that initial value. While you can change the value of the variable during a piston run, the variable will revert to its initial value on subsequent piston runs. If you plan on storing data in this variable that needs to persist between piston runs, leave the value as <i>Nothing Selected</i>.</label>
			</div>
			<div class="form-group" ng-if="(designer.operand.data.t != '') && (designer.operand.data.t != 'd') && designer.operand.dataType && !designer.operand.dataType.endsWith(']')">
				<label class="col-lg-12 no-padding">Assignment type</label>
				<select data-actions-box="true" id="type" selectpicker class="selectpicker show-tick input-addon" data-width="100%" data-style="btn-info" ng-model="designer.assignment" data-mobile="{{mobile}}">
					<option value="d">Dynamic (default)</option>
					<option value="s">Constant (value is static and cannot be changed)</option>
				</select>
			</div>
			<div ng-if="designer.showAdvancedOptions" class="form-group">
				<label for="descriptionInput">Description (optional)</label>
				<textarea type="text" id="descriptionInput" class="form-control" placeholder="Description for this statement" ng-model="designer.description" msd-elastic></textarea>
			</div>
		</form>

		<footer>
			<button type="button" ng-if="designer.$new" class="btn btn-info pull-right" ng-disabled="(!designer.name && (designer.name != 'true') && (designer.name != 'false')) || !designer.operand.valid" ng-click="updateVariable();">Add</button>
			<button type="button" ng-if="designer.$new" class="btn btn-success pull-right" ng-disabled="!designer.name || !designer.operand.valid" ng-click="updateVariable(true);">Add more</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-info pull-right" ng-disabled="!designer.name || !designer.operand.valid" ng-click="updateVariable();">Save</button>
			<button type="button" class="btn btn-default pull-right" ng-click="toggleAdvancedOptions();" title="Show/Hide advanced options"><i class="fa fa-cog"></i></button>
			<button type="button" class="btn btn-default" ng-click="closeDialog();">Cancel</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-danger" ng-click="deleteObject();">Delete</button>
		</footer>
	</designer>
</script>



<script type="text/ng-template" id="dialog-edit-local-variable">
	<designer>
		<header>
			<h3>Edit the {{designer.name}} local variable</h3>
		</header>
		<form>
			<div class="form-group">
				<label class="col-lg-12 no-padding">Value<span class="error" ng-if="!designer.operand.valid">{{designer.operand.error}}</label>
				<operand ng-repeat="operand in [designer.operand]" ng-model="designer.operand" ng-include="'operand'"></operand>
			</div>
		</form>

		<footer>
			<button type="button" class="btn btn-info pull-right" ng-disabled="!designer.operand.valid" ng-click="updateLocalVariable();">Save</button>
			<button type="button" class="btn btn-default" ng-click="closeDialog();">Cancel</button>
		</footer>
	</designer>
</script>


<script type="text/ng-template" id="dialog-edit-global-variable">
	<designer>
		<header>
			<h3>{{designer.$new ? 'Add a new' : 'Edit'}} global variable</h3>
		</header>
		<form>
			<div class="form-group">
				<div class="form-table input-group">
					<select data-actions-box="true" id="type" selectpicker class="selectpicker show-tick input-addon" data-width="25%" data-style="btn-info" ng-model="designer.operand.dataType" data-mobile="{{mobile}}" ng-change="validateOperand(designer.operand, true); refreshSelects()">
						<option value="dynamic">Dynamic</option>
						<option value="string">String (text)</option>
						<option value="boolean">Boolean (true/false)</option>
						<option value="integer">Number (integer)</option>
						<option value="decimal">Number (decimal)</option>
						<option value="datetime">Date and Time</option>
						<option value="date">Date (date only)</option>
						<option value="time">Time (time only)</option>
						<option value="device">Device</option>
					</select>
					<input class="form-control" id="name" ng-model="designer.name" type="text"/>
				</div>
			</div>
			<div class="form-group">
				<label class="col-lg-12 no-padding">Value<span class="error" ng-if="!designer.operand.valid">{{designer.operand.error}}</label>
				<operand ng-repeat="operand in [designer.operand]" ng-model="designer.operand" ng-include="'operand'"></operand>
			</div>
		</form>

		<footer>
			<button type="button" ng-if="designer.$new" class="btn btn-info pull-right" ng-disabled="!designer.name || !designer.operand.valid || !validateGlobalVariableName()" ng-click="updateGlobalVariable();">Add</button>
			<button type="button" ng-if="designer.$new" class="btn btn-success pull-right" ng-disabled="!designer.name || !designer.operand.valid || !validateGlobalVariableName()" ng-click="updateGlobalVariable(true);">Add more</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-info pull-right" ng-disabled="!designer.name || !designer.operand.valid || !validateGlobalVariableName()" ng-click="updateGlobalVariable();">Save</button>
			<button type="button" class="btn btn-default" ng-click="closeDialog();">Cancel</button>
			<button type="button" ng-if="!designer.$new" class="btn btn-danger" ng-click="deleteGlobalVariable();">Delete</button>
		</footer>
	</designer>
</script>



<script type="text/ng-template" id="dialog-del-piston">
	<designer>
		<header>
			<h3>Delete piston</h3>
		</header>
		<form>
			<div class="form-group">
				<label>Are you sure you want to delete piston "{{meta.name}}"?</label>
			</div>
			<div ng-if="meta.bin" class="form-group">
				<label>This is the last opportunity to save the backup bin code, just in case you decide you want this piston back later...</label>
				<div class="text-center"><p class="well bin animated" reveal="true">{{meta.bin}}</p></div>
			</div>
		</form>
		<footer>
			<button type="button" class="btn btn-default pull-right" ng-click="closeDialog();">Cancel</button>
			<button type="button" class="btn btn-danger" ng-click="del();">Delete</button>
		</footer>
	</designer>
</script>


<script type="text/ng-template" id="dialog-edit-settings">
	<designer>
		<header>
			<h3>Piston settings</h3>
		</header>
		<form>
			<div class="form-group">
				<label>Piston name</label>
				<input type="text" class="form-control" ng-model="designer.name" />
			</div>
			<div class="form-group">
				<label for="descriptionInput">Description (optional)</label>
				<textarea id="descriptionInput" class="form-control" placeholder="Description for this piston" ng-model="designer.description" msd-elastic="\n"></textarea>
			</div>
			<div class="form-group">
				<label class="col-lg-12 no-padding">Automatic piston state</label>
				<select data-actions-box="true" id="type" selectpicker class="selectpicker show-tick input-addon" data-width="100%" data-style="btn-info" ng-model="designer.automaticState" data-mobile="{{mobile}}">
					<option ng-value="0">Enabled (default)</option>
					<option ng-value="1">Disabled</option>
				</select>
			</div>

			<div ng-if="designer.showAdvancedOptions" class="form-group">
				<div class="form-group">
					<label class="col-lg-12 no-padding">Piston execution parallelism</label>
					<select data-actions-box="true" id="type" selectpicker class="selectpicker show-tick input-addon" data-width="100%" data-style="btn-info" ng-model="designer.executionParallelism" data-mobile="{{mobile}}">
						<option ng-value="1">Enabled</option>
						<option ng-value="0">Disabled (default)</option>
					</select>
				</div>
				<div class="form-group">
					<label class="col-lg-12 no-padding">Command optimizations</label>
					<select data-actions-box="true" id="type" selectpicker class="selectpicker show-tick input-addon" data-width="100%" data-style="btn-info" ng-model="designer.commandOptimizations" data-mobile="{{mobile}}">
						<option ng-value="0">Enabled (default)</option>
						<option ng-value="1">Disabled</option>
					</select>
				</div>
				<div class="form-group">
					<label class="col-lg-12 no-padding">Condition traversal optimizations</label>
					<select data-actions-box="true" id="type" selectpicker class="selectpicker show-tick input-addon" data-width="100%" data-style="btn-info" ng-model="designer.conditionOptimizations" data-mobile="{{mobile}}">
						<option ng-value="0">Enabled (default)</option>
						<option ng-value="1">Disabled</option>
					</select>
				</div>
				<div class="form-group">
					<label class="col-lg-12 no-padding">Event subscriptions</label>
					<select data-actions-box="true" id="type" selectpicker class="selectpicker show-tick input-addon" data-width="100%" data-style="btn-info" ng-model="designer.eventSubscriptions" data-mobile="{{mobile}}">
						<option ng-value="0">Enabled (default)</option>
						<option ng-value="1">Disabled</option>
					</select>
				</div>
				<div class="form-group">
					<label class="col-lg-12 no-padding">Allow pre-scheduled tasks to execute during restrictions</label>
					<select data-actions-box="true" id="type" selectpicker class="selectpicker show-tick input-addon" data-width="100%" data-style="btn-info" ng-model="designer.allowPreSchedules" data-mobile="{{mobile}}">
						<option ng-value="1">Enabled</option>
						<option ng-value="0">Disabled (default)</option>
					</select>
				</div>
				<div class="form-group">
					<label class="col-lg-12 no-padding">Command execution delay</label>
					<div class="input-group">
						<input type="number" class="form-control" ng-model="designer.commandDelay" min="0" max="5000"/>
						<span class="input-group-addon">ms</span>
					</div>
				</div>
			</div>
		</form>
		<footer>
			<button type="button" class="btn btn-info pull-right" ng-disabled="!designer.name" ng-click="updateSettings();">Save</button>
			<button type="button" class="btn btn-default pull-right" ng-click="toggleAdvancedOptions();" title="Show/Hide advanced options"><i class="fa fa-cog"></i></button>
			<button type="button" class="btn btn-default" ng-click="closeDialog();">Cancel</button>
		</footer>
	</designer>
</script>


<script type="text/ng-template" id="dialog-wiki">
	<iframe border="0" src="{{wikiUrl}}">Loading, please wait...</iframe>
</script>

<script type="text/ng-template" id="dialog-choose-version">
	<designer>
		<header>
			<h3>A local, newer, version of this piston was found</h3>
		</header>
		<form>
			<div class="form-group">
				<label>It looks like you have been working on this piston and did not save the changes, which caused a local version of the piston to exist that is not the same as the current running piston. Please select which version of the piston you would like to work on.</label>
				<label class="danger">Selecting the current version will delete the locally stored version and will revert to the piston version that is currently running. The local version will be forever lost.</label>
			</div>
		</form>
		<footer>
			<div class="row text-center">
				<div class="col-sm-6">
					<button type="button" class="btn btn-danger" ng-click="chooseVersion(false);">Use the current version</button>
				</div>
				<div class="col-sm-6">
					<button type="button" class="btn btn-success" ng-click="chooseVersion(true);">Use the locally saved version</button>
				</div>
			</div>
		</footer>
	</designer>
</script>


<script type="text/ng-template" id="dialog-rebuild-piston">
	<designer>
		<header>
			<h3>Rebuild piston items</h3>
		</header>
		<form>
			<info>This piston is using some items that do not exist in your webCoRE instance. Let's replace them with items you do have. Please try and select an equivalent value for each item in the list below. If you skip any items, you will have to fix them by manually visiting that statement.</info>
			<div ng-repeat="(key, item) in designer.legend">
				<div class="form-group" ng-if="item.t == 'contact'">
					<label class="col-lg-12 no-padding">Contact</label>
					<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-info" ng-model="item.id"  data-header="Use the input box below to quickly search for devices" data-live-search="true" data-mobile="{{mobile}}" ng-required>
						<option ng-repeat="(id, contact) in item.i" value="{{id}}">{{contact.f}} {{contact.l}} - {{contact.t}} ({{contact.p ? 'PUSH' : 'SMS'}})</option>
					</select>
				</div>
				<div class="form-group" ng-if="item.t == 'device'">
					<label class="col-lg-12 no-padding">Device: {{item.n}}</label>
					<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-info" ng-model="item.id"  data-header="Use the input box below to quickly search for devices" data-live-search="true" data-mobile="{{mobile}}" ng-required>
						<option ng-repeat="(id, device) in item.i" data-tokens="{{device.tokens}}" value="{{id}}">{{device.n}}</option>
					</select>
				</div>
				<div class="form-group" ng-if="item.t == 'mode'">
					<label class="col-lg-12 no-padding">Location mode: {{item.n}}</label>
					<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-info" ng-model="item.id"  data-header="Use the input box below to quickly search for devices" data-live-search="true" data-mobile="{{mobile}}" ng-required>
						<option ng-repeat="(id, mode) in item.i" value="{{id}}">{{mode}}</option>
					</select>
				</div>
				<div class="form-group" ng-if="item.t == 'routine'">
					<label class="col-lg-12 no-padding">Routine: {{item.n}}</label>
					<select data-actions-box="true" selectpicker class="selectpicker show-tick" data-width="100%" data-style="btn-info" ng-model="item.id"  data-header="Use the input box below to quickly search for devices" data-live-search="true" data-mobile="{{mobile}}" ng-required>
						<option ng-repeat="(id, routine) in item.i" value="{{id}}">{{routine}}</option>
					</select>
				</div>
				<div class="form-group" ng-if="item.t == 'phone'">
					<label class="col-lg-12 no-padding">Phone number</label>
					<input type="text" ng-model="item.id" />
				</div>
				<div class="form-group" ng-if="item.t == 'uri'">
					<label class="col-lg-12 no-padding">URL</label>
					<input type="text" ng-model="item.id" />
				</div>
				<div class="form-group" ng-if="item.t == 'email'">
					<label class="col-lg-12 no-padding">Email</label>
					<input type="text" ng-model="item.id" />
				</div>
			</div>
		</form>
		<footer>
			<button type="button" class="btn btn-default" ng-click="closeDialog();">Ignore</button>
			<button type="button" class="btn btn-info pull-right" ng-click="doRebuildPiston();">Continue</button>
		</footer>
	</designer>
</script>
